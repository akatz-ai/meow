[
  {
    "name": "stream-a-ipc-cli",
    "beads": "meow-cd16 meow-khbf meow-bc0y",
    "prompt": "# Stream A: IPC & CLI Fixes\n\nYou are working on IPC client consistency and CLI improvements.\n\n## Task 1 (P1 Critical): Fix meow done socket handling\n\n**Bead:** `meow-cd16`\n\nThe `meow done` command checks MEOW_ORCH_SOCK but then ignores it.\n\n**Files:** `cmd/meow/cmd/done.go`, `cmd/meow/cmd/session_id.go`\n\n**Problem at done.go:57-108:**\n```go\n// Line 57: checks env var\nif os.Getenv(\"MEOW_ORCH_SOCK\") == \"\" { return nil }\n// Line 108: IGNORES the env var, derives from workflow ID\nclient := ipc.NewClientForWorkflow(workflowID)\n```\n\n**Fix:** Store socket path when checking, use `ipc.NewClient(sockPath)` like `event.go` does.\n\n---\n\n## Task 2 (P2): Implement approve/reject CLI commands\n\n**Bead:** `meow-khbf`\n\n**Files:** `cmd/meow/cmd/approve.go`, `cmd/meow/cmd/reject.go`\n\nCurrently stubs that print \"not yet implemented\". IPC infrastructure exists:\n- `ipc.MsgApproval` message type\n- `ipc_handler.go:HandleApproval` handler\n- `ipc/client.go:SendApproval` method\n\n**Implement:**\n```go\nfunc runApprove(cmd *cobra.Command, args []string) error {\n    sockPath := os.Getenv(\"MEOW_ORCH_SOCK\")\n    if sockPath == \"\" {\n        // Derive from workflow ID for manual use\n        sockPath = ipc.SocketPath(workflowID)\n    }\n    client := ipc.NewClient(sockPath)\n    return client.SendApproval(workflowID, gateID, true, approver)\n}\n```\n\n---\n\n## Task 3 (P3): Deterministic step ordering\n\n**Bead:** `meow-bc0y`\n\n**File:** `internal/types/workflow.go:115-124`\n\n`GetReadySteps()` iterates over `map[string]*Step` which has random order in Go.\n\n**Fix:** Sort ready steps by ID before returning:\n```go\nsort.Slice(ready, func(i, j int) bool {\n    return ready[i].ID < ready[j].ID\n})\n```\n\n---\n\n## Workflow\n\n1. Run `bd show <bead-id>` for each bead to get full requirements\n2. Fix each issue with TDD (write test first)\n3. Commit after each fix\n4. Close beads as you complete: `bd close <bead-id>`\n5. Run `go test -short ./...` to verify\n\nWhen ALL tasks complete: `meow done`"
  },
  {
    "name": "stream-b-vars-outputs",
    "beads": "meow-r8wp meow-o22f",
    "prompt": "# Stream B: Variable & Output Handling\n\nYou are fixing variable and output handling in the template system.\n\n## Task 1 (P1 Critical): Fix non-string output stringification\n\n**Bead:** `meow-r8wp`\n\n**Files:** `internal/template/vars.go`, `internal/orchestrator/orchestrator.go`\n\n**Problem:** Maps/slices become `map[foo:bar]` instead of valid JSON `{\"foo\":\"bar\"}`.\n\n**Locations using `fmt.Sprintf(\"%v\")`:**\n- `vars.go:74` - Get()\n- `vars.go:132` - Substitute()\n- `vars.go:501` - SubstituteForShell()\n- `orchestrator.go:503` - resolveStepOutputRefs fallback\n\n**Fix:** Create helper that JSON-marshals structured types:\n```go\nfunc stringifyValue(val any) string {\n    switch v := val.(type) {\n    case string:\n        return v\n    case fmt.Stringer:\n        return v.String()\n    case map[string]any, []any, map[string]string:\n        if b, err := json.Marshal(v); err == nil {\n            return string(b)\n        }\n    }\n    return fmt.Sprintf(\"%v\", val)\n}\n```\n\n**Note:** `executor_foreach.go:191` already does this correctly with `json.Marshal(item)`.\n\n---\n\n## Task 2 (P3): Fix variable defaults conflating unset with empty\n\n**Bead:** `meow-o22f`\n\n**Files:** `internal/template/vars.go`, `internal/template/baker.go`\n\n**Problem:** Can't set a variable to empty string because defaults override it.\n\n**At baker.go:68:**\n```go\nif v.Default != nil && b.VarContext.Get(name) == \"\" {  // BUG\n```\n\n`Get()` returns `\"\"` for BOTH unset AND empty-string values.\n\n**Correct pattern exists at vars.go:300 (ApplyDefaults):**\n```go\nif _, ok := c.Variables[name]; !ok && v.Default != nil {  // Checks presence\n```\n\n**Fix:** Add `Has()` method to VarContext:\n```go\nfunc (c *VarContext) Has(name string) bool {\n    _, ok := c.Variables[name]\n    return ok\n}\n```\n\nThen update baker.go to use `!c.Has(name)` instead of `c.Get(name) == \"\"`.\n\n---\n\n## NOTE: Follow-up Task (meow-kqgp)\n\nAfter you complete these fixes, there's a larger refactor task (meow-kqgp) that will\nunify all variable substitution into a single engine. Your changes to `stringifyValue`\nand `Has()` will be used by that refactor. DO NOT work on meow-kqgp in this sprint -\nit will be done in a follow-up sprint after all 4 streams merge.\n\n---\n\n## Workflow\n\n1. Run `bd show <bead-id>` for full requirements\n2. Write failing tests first\n3. Implement fixes\n4. Verify: `go test ./internal/template/... ./internal/orchestrator/...`\n5. Close beads: `bd close meow-r8wp meow-o22f`\n\nWhen complete: `meow done`"
  },
  {
    "name": "stream-c-template-legacy",
    "beads": "meow-wafg meow-7495",
    "prompt": "# Stream C: Template System Cleanup\n\nYou are cleaning up the template system - removing legacy code and fixing inline steps.\n\n## Task 1 (P1 Critical): Remove all legacy template support\n\n**Bead:** `meow-wafg`\n\nCLAUDE.md says: \"No legacy format support. Delete old code.\"\n\n**Files to modify:**\n- `internal/template/module.go` - Remove FormatLegacy detection, cleanup fallback\n- `internal/template/parser.go` - Remove deprecated fields (Type, Assignee, Instructions, Code, LegacyOutputs, etc.)\n- `internal/template/baker.go` - Remove fallback chains (Code→Command, Assignee→Agent, etc.)\n- `internal/template/vars.go` - Remove legacy output reference pattern\n- `internal/template/*_test.go` - Remove legacy format tests\n\n**Key deletions:**\n\n1. **module.go:57-65** - DetectFormat with [meta] heuristic\n2. **parser.go:158-172** - Deprecated Step fields\n3. **parser.go:293-304** - TaskOutputSpec/TaskOutputDef types\n4. **baker.go:130-157** - templateTypeToExecutor mapping\n5. **baker.go fallbacks** - Code→Command (183-186), Assignee→Agent (243-246), etc.\n\n**Before removing:** Verify .meow/ templates don't use legacy syntax (they shouldn't).\n\n---\n\n## Task 2 (P2): Add variable substitution to inline branch steps\n\n**Bead:** `meow-7495`\n\n**File:** `internal/orchestrator/executor_branch.go:173-210`\n\n**Problem:** `expandInlineSteps()` only handles agent executor:\n```go\nif is.Executor == types.ExecutorAgent {\n    newStep.Agent = &types.AgentConfig{...}  // Only this gets substitution\n}\n// Shell, spawn, kill - NO SUBSTITUTION!\n```\n\n**Fix:** Convert InlineStep to full Step, then use existing `substituteStepVariables()`:\n```go\nfunc expandInlineSteps(...) {\n    for _, is := range inline {\n        newStep := inlineStepToStep(is, parentID)\n        substituteStepVariables(newStep, vars)  // Reuse existing logic\n        result.ExpandedSteps = append(...)\n    }\n}\n```\n\nThis ensures all executor types get variable substitution.\n\n---\n\n## Workflow\n\n1. **First:** Audit .meow/ templates for legacy syntax\n2. Remove legacy code incrementally, running tests after each change\n3. Write tests for inline branch substitution\n4. Implement inline fix\n5. Run full test suite: `go test ./internal/template/... ./internal/orchestrator/...`\n6. Close beads: `bd close meow-wafg meow-7495`\n\nWhen complete: `meow done`"
  },
  {
    "name": "stream-d-shell-infra",
    "beads": "meow-xuoq meow-on0j meow-2lzw",
    "prompt": "# Stream D: Shell & Infrastructure\n\nYou are fixing shell environment and cleaning up infrastructure code.\n\n## Task 1 (P2): Inject MEOW_* env vars into shell executor\n\n**Bead:** `meow-xuoq`\n\n**File:** `internal/orchestrator/executor_shell.go:64-68`\n\n**Problem:** Shell only inherits `os.Environ()` + `cfg.Env`, missing MEOW_* injection.\n\n**Correct patterns exist:**\n- `executor_spawn.go:62-65` - Injects MEOW_AGENT, MEOW_WORKFLOW\n- `executor_branch.go:214-225` - Injects MEOW_ORCH_SOCK\n\n**Fix:** Add MEOW_* injection to ExecuteShell:\n```go\ncmd.Env = os.Environ()\ncmd.Env = append(cmd.Env, fmt.Sprintf(\"MEOW_WORKFLOW=%s\", workflowID))\ncmd.Env = append(cmd.Env, fmt.Sprintf(\"MEOW_STEP=%s\", stepID))\nif e.SocketPath != \"\" {\n    cmd.Env = append(cmd.Env, fmt.Sprintf(\"MEOW_ORCH_SOCK=%s\", e.SocketPath))\n}\n```\n\n---\n\n## Task 2 (P3): Remove tmux code duplication\n\n**Bead:** `meow-on0j`\n\n**Files:**\n- `internal/agent/tmux_wrapper.go` - Generic (currently unused)\n- `internal/orchestrator/agent_manager.go:416-508` - Reimplements same functions\n\n**Duplicated functions:**\n- createSession / NewSession\n- sessionExists / SessionExists  \n- killSession / KillSession\n- sendKeys / SendKeys\n\n**Fix:** Extend TmuxWrapper with socket path support, use it in AgentManager:\n```go\ntype TmuxWrapper struct {\n    socketPath string  // Add this\n}\n\nfunc WithSocketPath(path string) TmuxOption {...}\n```\n\nThen replace AgentManager's inline helpers with TmuxWrapper calls.\n\n---\n\n## Task 3 (P4): Add foreach dynamic items E2E tests\n\n**Bead:** `meow-2lzw`\n\n**Files:** `internal/testutil/e2e/`, add test templates\n\n**Test scenarios:**\n1. Step A outputs JSON array, step B foreach iterates → verify correct items\n2. Empty array → no iterations, workflow succeeds\n3. Nested objects → item.field access works\n\n**Example template:**\n```toml\n[[test.steps]]\nid = \"generate\"\nexecutor = \"shell\"\ncommand = \"echo '[\\\"a\\\",\\\"b\\\",\\\"c\\\"]'\"\n[test.steps.outputs]\nitems = { source = \"stdout\", type = \"json\" }\n\n[[test.steps]]\nid = \"process\"\nexecutor = \"foreach\"\nitems = \"{{generate.outputs.items}}\"\n```\n\n---\n\n## Workflow\n\n1. Start with shell env injection (most impactful)\n2. Write tests for shell MEOW_* vars\n3. Clean up tmux duplication\n4. Add foreach E2E tests\n5. Run: `go test ./...`\n6. Close beads: `bd close meow-xuoq meow-on0j meow-2lzw`\n\nWhen complete: `meow done`"
  }
]
