# ============================================================================
# MEOW Workflow: foreach Executor Implementation Sprint
# ============================================================================
#
# Implements the foreach executor (meow-x4s epic) using dual parallel agents.
#
# Track 1 (Foundation): Types, Parser, Data Layer
# Track 2 (Execution): Core Logic, Modes, Tests
#
# Usage:
#   meow run .meow/templates/foreach-sprint.meow.toml
#   meow run .meow/templates/foreach-sprint.meow.toml --var 'skip_merge_to_target=true'
#
# ============================================================================

[main]
name = "foreach-sprint"
description = "Implement the foreach executor with dual parallel agents"

[main.variables]
target_branch = { default = "main", description = "Target branch (use feature branch to avoid conflicts)" }
skip_merge_to_target = { default = "false", description = "If true, push branch instead of merging" }

cleanup = """
echo "Cleaning up worktrees..."
git worktree remove .meow/worktrees/foreach-foundation-track --force 2>/dev/null || true
git worktree remove .meow/worktrees/foreach-execution-track --force 2>/dev/null || true
git worktree remove .meow/worktrees/foreach-integration-track --force 2>/dev/null || true
echo "Cleanup complete"
"""

# ============================================================================
# PHASE 1: Create Worktrees (Shell steps for reliable output capture)
# ============================================================================

[[main.steps]]
id = "create-worktree-1"
executor = "shell"
description = "Create worktree for foundation track"
command = """
set -e
WORKTREE=".meow/worktrees/foreach-foundation-track"
BRANCH="foreach-foundation-track-$(date +%s)"
if [ -d "$WORKTREE" ]; then
    git worktree remove "$WORKTREE" --force 2>/dev/null || rm -rf "$WORKTREE"
fi
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }

[[main.steps]]
id = "create-worktree-2"
executor = "shell"
description = "Create worktree for execution track"
needs = ["create-worktree-1"]
command = """
set -e
WORKTREE=".meow/worktrees/foreach-execution-track"
BRANCH="foreach-execution-track-$(date +%s)"
if [ -d "$WORKTREE" ]; then
    git worktree remove "$WORKTREE" --force 2>/dev/null || rm -rf "$WORKTREE"
fi
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }

[[main.steps]]
id = "create-worktree-3"
executor = "shell"
description = "Create worktree for integration track"
needs = ["create-worktree-2"]
command = """
set -e
WORKTREE=".meow/worktrees/foreach-integration-track"
BRANCH="foreach-integration-track-$(date +%s)"
if [ -d "$WORKTREE" ]; then
    git worktree remove "$WORKTREE" --force 2>/dev/null || rm -rf "$WORKTREE"
fi
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }

# ============================================================================
# PHASE 2: Track 1 - Foundation (Types, Parser, Data)
# ============================================================================

[[main.steps]]
id = "spawn-foundation"
executor = "spawn"
agent = "agent-foundation"
workdir = "{{create-worktree-1.outputs.path}}"
needs = ["create-worktree-1"]

[[main.steps]]
id = "work-foundation"
executor = "agent"
agent = "agent-foundation"
needs = ["spawn-foundation"]
prompt = """
# Foundation Track: foreach Executor

## FIRST: Read the Specification
@docs/MVP-SPEC-v2.md (search for "foreach")

## Your 4 Beads

### 1. meow-5ex: Define ForeachConfig type and fields
Create the ForeachConfig struct in internal/types/step.go:
```go
type ForeachConfig struct {
    Items         string            `yaml:"items" toml:"items"`
    ItemVar       string            `yaml:"item_var" toml:"item_var"`
    IndexVar      string            `yaml:"index_var,omitempty" toml:"index_var,omitempty"`
    Template      string            `yaml:"template" toml:"template"`
    Variables     map[string]string `yaml:"variables,omitempty" toml:"variables,omitempty"`
    Parallel      bool              `yaml:"parallel,omitempty" toml:"parallel,omitempty"`       // default true
    MaxConcurrent int               `yaml:"max_concurrent,omitempty" toml:"max_concurrent,omitempty"`
    Join          bool              `yaml:"join,omitempty" toml:"join,omitempty"`               // default true
}
```
Add `ExecutorForeach ExecutorType = "foreach"` to constants.
Add `Foreach *ForeachConfig` to Step struct.
Update `validateConfig()` and `IsOrchestrator()`.

### 2. meow-3xa: Add foreach to template parser
Update internal/template/parser.go to parse foreach steps from TOML.

### 3. meow-qvy: Implement items expression evaluation
Create a function to evaluate `{{step.outputs.array}}` to `[]any`.

### 4. meow-1mc: Implement item_var and index_var substitution
Extend variable substitution to handle item_var and index_var during expansion.

## Workflow
1. `bd show <bead-id>` for details
2. Write tests first
3. Commit per bead: `feat(foreach): <desc> [<bead-id>]`
4. Close each: `bd close <bead-id>`

When done: `meow done`
"""

[[main.steps]]
id = "review-foundation"
executor = "agent"
agent = "agent-foundation"
needs = ["work-foundation"]
prompt = """
# Self-Review: Foundation Track

Review your code changes with fresh eyes:
1. Read each modified file
2. Check for bugs, typos, missing imports
3. Run `go build ./...` and `go test ./internal/types/...`
4. Fix issues and commit: `fix: self-review corrections`

When done: `meow done`
"""

[[main.steps]]
id = "verify-foundation"
executor = "agent"
agent = "agent-foundation"
needs = ["review-foundation"]
prompt = """
# Final Check: Foundation Track

1. `git status` - ensure clean
2. If uncommitted: `git add -A && git commit -m "chore: final foundation changes"`
3. `git log --oneline -5`

When clean: `meow done`
"""

[[main.steps]]
id = "kill-foundation"
executor = "kill"
agent = "agent-foundation"
needs = ["verify-foundation"]
graceful = true

[[main.steps]]
id = "foundation-done"
executor = "shell"
command = "echo 'Foundation track complete'"
needs = ["kill-foundation"]

# ============================================================================
# PHASE 2: Track 2 - Execution (Core Logic, Modes, Tests)
# ============================================================================

[[main.steps]]
id = "spawn-execution"
executor = "spawn"
agent = "agent-execution"
workdir = "{{create-worktree-2.outputs.path}}"
needs = ["create-worktree-2"]

[[main.steps]]
id = "work-execution"
executor = "agent"
agent = "agent-execution"
needs = ["spawn-execution"]
prompt = """
# Execution Track: foreach Executor

## FIRST: Read the Specification
@docs/MVP-SPEC-v2.md (search for "foreach")

## Your 6 Beads

### 1. meow-mfr: Implement foreach expansion logic
Create internal/orchestrator/executor_foreach.go:
- Evaluate items to get array
- For each item: expand template with prefixed step IDs
- Child step IDs: `{foreach_id}.{index}.{step_id}`
- Track expanded_into on foreach step

### 2. meow-ako: Parallel iteration with max_concurrent
When parallel=true: start all iterations, limit concurrent if max_concurrent set.

### 3. meow-je8: Sequential iteration
When parallel=false: chain iterations with needs.

### 4. meow-fus: Implicit join semantics
When join=true: foreach stays running until all children done.

### 5. meow-p8v: Fire-and-forget mode
When join=false: foreach done after expansion.

### 6. meow-a02: Add foreach executor tests
Create internal/orchestrator/executor_foreach_test.go with comprehensive tests.

## Note
Foundation track is implementing types. You may need stub types initially.

## Workflow
1. `bd show <bead-id>` for details
2. Write tests first (TDD)
3. Commit per bead: `feat(foreach): <desc> [<bead-id>]`
4. Close each: `bd close <bead-id>`

When done: `meow done`
"""

[[main.steps]]
id = "review-execution"
executor = "agent"
agent = "agent-execution"
needs = ["work-execution"]
prompt = """
# Self-Review: Execution Track

Review your code changes with fresh eyes:
1. Read each modified file
2. Check for bugs, typos, missing imports
3. Run `go build ./...` and `go test ./internal/orchestrator/...`
4. Fix issues and commit: `fix: self-review corrections`

When done: `meow done`
"""

[[main.steps]]
id = "verify-execution"
executor = "agent"
agent = "agent-execution"
needs = ["review-execution"]
prompt = """
# Final Check: Execution Track

1. `git status` - ensure clean
2. If uncommitted: `git add -A && git commit -m "chore: final execution changes"`
3. `git log --oneline -5`

When clean: `meow done`
"""

[[main.steps]]
id = "kill-execution"
executor = "kill"
agent = "agent-execution"
needs = ["verify-execution"]
graceful = true

[[main.steps]]
id = "execution-done"
executor = "shell"
command = "echo 'Execution track complete'"
needs = ["kill-execution"]

# ============================================================================
# PHASE 3: Merge Tracks into Integration
# ============================================================================

[[main.steps]]
id = "merge-tracks"
executor = "shell"
description = "Merge both tracks into integration worktree"
needs = ["foundation-done", "execution-done", "create-worktree-3"]
command = """
set -e
cd .meow/worktrees/foreach-integration-track

BRANCH_1=$(cat ../foreach-foundation-track/.meow-branch)
BRANCH_2=$(cat ../foreach-execution-track/.meow-branch)

echo "Merging foundation track ($BRANCH_1)..."
git merge "$BRANCH_1" --no-edit -m "Merge: foreach foundation (types, parser, data)"

echo "Merging execution track ($BRANCH_2)..."
git merge "$BRANCH_2" --no-edit -m "Merge: foreach execution (logic, modes, tests)"

echo "All tracks merged"
git log --oneline -15
"""

# ============================================================================
# PHASE 4: Integration Testing
# ============================================================================

[[main.steps]]
id = "spawn-integration"
executor = "spawn"
agent = "agent-integration"
workdir = "{{create-worktree-3.outputs.path}}"
needs = ["merge-tracks"]

[[main.steps]]
id = "work-integration"
executor = "agent"
agent = "agent-integration"
needs = ["spawn-integration"]
prompt = """
# Integration Agent: foreach Executor

Both tracks merged. Your tasks:

## 1. Verify Build
```bash
go build ./...
```

## 2. Run All Tests
```bash
go test ./... -v 2>&1 | tail -100
```

## 3. Fix Integration Issues
- Resolve interface mismatches between tracks
- Ensure types and executor work together
- Fix any test failures

## 4. Create Simple E2E Test
Create a test template that uses foreach and verify it parses correctly.

## 5. Close Epic (if all beads done)
```bash
bd list --status=open | grep -E "meow-(5ex|3xa|qvy|1mc|mfr|ako|je8|fus|p8v|a02)"
# If all closed:
bd close meow-x4s --reason "foreach executor implemented"
```

Commit fixes: `git add -A && git commit -m "fix(foreach): integration fixes"`

When done: `meow done`
"""

[[main.steps]]
id = "review-integration"
executor = "agent"
agent = "agent-integration"
needs = ["work-integration"]
prompt = """
# Final Review: Integration

1. Run full test suite: `go test ./...`
2. Verify no uncommitted changes: `git status`
3. If changes: commit them
4. `git log --oneline main..HEAD`

When done: `meow done`
"""

[[main.steps]]
id = "kill-integration"
executor = "kill"
agent = "agent-integration"
needs = ["review-integration"]
graceful = true

# ============================================================================
# PHASE 5: Final Merge
# ============================================================================

[[main.steps]]
id = "spawn-merge"
executor = "spawn"
agent = "merge-agent"
workdir = "{{create-worktree-3.outputs.path}}"
needs = ["kill-integration"]

[[main.steps]]
id = "final-merge"
executor = "agent"
agent = "merge-agent"
needs = ["spawn-merge"]
prompt = """
# Merge Agent: foreach Implementation

## Skip Merge Mode: {{skip_merge_to_target}}
## Target Branch: {{target_branch}}

### If skip_merge_to_target is "true":
Push the integration branch for PR:
```bash
BRANCH=$(cat .meow-branch)
cd /data/projects/meow-machine
git push -u origin "$BRANCH"
echo "Branch $BRANCH pushed. Create PR to {{target_branch}}"
```

### If skip_merge_to_target is "false":
Merge to {{target_branch}}:
```bash
cd /data/projects/meow-machine
BRANCH=$(cat .meow/worktrees/foreach-integration-track/.meow-branch)
git checkout {{target_branch}}
git pull origin {{target_branch}}
git merge "$BRANCH" --no-edit -m "feat(foreach): Implement foreach executor [meow-x4s]"
go test ./... 2>&1 | tail -20
git push origin {{target_branch}}
```

When done: `meow done`
"""

[[main.steps]]
id = "kill-merge"
executor = "kill"
agent = "merge-agent"
needs = ["final-merge"]
graceful = true

[[main.steps]]
id = "workflow-done"
executor = "shell"
needs = ["kill-merge"]
command = """
echo "=============================================="
echo "  FOREACH SPRINT COMPLETE"
echo "=============================================="
echo "Beads implemented:"
echo "  Foundation: meow-5ex, meow-3xa, meow-qvy, meow-1mc"
echo "  Execution:  meow-mfr, meow-ako, meow-je8, meow-fus, meow-p8v, meow-a02"
echo "Epic: meow-x4s (foreach executor)"
echo "=============================================="
"""
