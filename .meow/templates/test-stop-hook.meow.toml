# Test: Stop Hook / meow prime
#
# Tests that meow prime can see the current agent's task.
# This validates the "pull" mechanism that stop hooks would use.
#
# The stop hook flow would be:
# 1. Claude finishes a response -> stop hook fires
# 2. Stop hook runs: meow prime --format=prompt
# 3. meow prime outputs the prompt for pending work
# 4. Claude Code injects that as the next input
#
# This test verifies meow prime returns correct info when called
# from within an agent's context.
#
# Usage:
#   meow run .meow/templates/test-stop-hook.meow.toml

[main]
name = "test-stop-hook"
description = "Test meow prime from agent context"

# Step 1: Spawn agent
[[main.steps]]
id = "spawn-agent"
executor = "spawn"
description = "Start the agent"
agent = "hook-tester"

# Step 2: First task - verify meow prime sees this step
[[main.steps]]
id = "task-verify-prime"
executor = "agent"
description = "Verify meow prime returns current task"
needs = ["spawn-agent"]
agent = "hook-tester"
prompt = """
You are testing the meow prime command. This is task-verify-prime.

Your task:
1. Run this command to see what meow prime shows:
   meow prime --format=text

2. Verify the output shows:
   - Workflow ID: should start with "wf-"
   - Current Step: "task-verify-prime"
   - Mode: "autonomous"

3. Write the meow prime output to /tmp/meow-prime-test.txt
   Run: meow prime --format=text > /tmp/meow-prime-test.txt

4. Signal completion with: meow done

Note: This tests the "pull" mechanism - meow prime shows what work
is assigned to you, which is exactly what a stop hook would query.
"""

# Step 3: Second task - verify sequential prompts work
[[main.steps]]
id = "task-sequential"
executor = "agent"
description = "Second task to same agent"
needs = ["task-verify-prime"]
agent = "hook-tester"
prompt = """
This is task-sequential (step 2).

The previous step should have written to /tmp/meow-prime-test.txt.

Your task:
1. Check if /tmp/meow-prime-test.txt exists and contains "task-verify-prime"
2. Run: grep "task-verify-prime" /tmp/meow-prime-test.txt || echo "NOT FOUND"
3. Signal completion with: meow done --output verified=yes
"""

# Step 4: Kill agent
[[main.steps]]
id = "kill-agent"
executor = "kill"
description = "Stop the agent"
needs = ["task-sequential"]
agent = "hook-tester"
graceful = true

# Step 5: Verify results
[[main.steps]]
id = "verify-results"
executor = "shell"
description = "Check test results"
needs = ["kill-agent"]
command = """
echo "=== Stop Hook Test Results ==="

if [ -f /tmp/meow-prime-test.txt ]; then
    echo "meow prime output captured:"
    cat /tmp/meow-prime-test.txt

    if grep -q "task-verify-prime" /tmp/meow-prime-test.txt; then
        echo ""
        echo "SUCCESS: meow prime correctly showed the running step!"
    else
        echo ""
        echo "PARTIAL: File exists but step ID not found"
    fi

    rm -f /tmp/meow-prime-test.txt
else
    echo "WARNING: meow prime output file not created"
fi

echo ""
echo "Test complete - meow prime works from agent context."
"""
