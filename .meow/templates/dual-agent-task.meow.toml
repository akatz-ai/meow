# ============================================================================
# MEOW Workflow: Dual Agent Task Runner
# ============================================================================
#
# Two parallel agents with parameterized task inputs:
#   1. Create worktrees (serialized to avoid git conflicts)
#   2. Spawn agent-1 -> work -> review -> verify-clean -> kill (parallel with agent-2)
#   3. Spawn agent-2 -> work -> review -> verify-clean -> kill (parallel with agent-1)
#   4. Spawn merge agent -> review all changes -> merge both to main -> kill
#
# Usage:
#   meow run .meow/templates/dual-agent-task.meow.toml \
#     --var 'task_prompt_1=First agent task description' \
#     --var 'task_prompt_2=Second agent task description'
#
# ============================================================================

[main]
name = "dual-agent-task"
description = "Two parallel agents with full lifecycle, then merge"

[main.variables]
agent_name_1 = { default = "agent-1", description = "Name for the first agent" }
track_name_1 = { default = "track-1", description = "Track name for first agent" }
task_prompt_1 = { required = true, description = "Task prompt for first agent" }

agent_name_2 = { default = "agent-2", description = "Name for the second agent" }
track_name_2 = { default = "track-2", description = "Track name for second agent" }
task_prompt_2 = { required = true, description = "Task prompt for second agent" }

cleanup = """
echo "Cleaning up worktrees..."
git worktree remove .meow/worktrees/{{track_name_1}}-track --force 2>/dev/null || true
git worktree remove .meow/worktrees/{{track_name_2}}-track --force 2>/dev/null || true
echo "Cleanup complete"
"""

# ============================================================================
# PHASE 1: Create Worktrees (Serialized to avoid git conflicts)
# ============================================================================

[[main.steps]]
id = "create-worktree-1"
executor = "shell"
description = "Create worktree for {{track_name_1}}"
command = """
set -e
WORKTREE=".meow/worktrees/{{track_name_1}}-track"
BRANCH="{{track_name_1}}-track-$(date +%s)"
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }
branch = { source = "file:.meow/worktrees/{{track_name_1}}-track/.meow-branch" }

[[main.steps]]
id = "create-worktree-2"
executor = "shell"
description = "Create worktree for {{track_name_2}}"
needs = ["create-worktree-1"]
command = """
set -e
WORKTREE=".meow/worktrees/{{track_name_2}}-track"
BRANCH="{{track_name_2}}-track-$(date +%s)"
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }
branch = { source = "file:.meow/worktrees/{{track_name_2}}-track/.meow-branch" }

# ============================================================================
# PHASE 2A: Agent 1 Lifecycle (runs in parallel with Agent 2)
# ============================================================================

[[main.steps]]
id = "spawn-agent-1"
executor = "spawn"
agent = "{{agent_name_1}}"
workdir = "{{create-worktree-1.outputs.path}}"
needs = ["create-worktree-1"]

[[main.steps]]
id = "work-1"
executor = "agent"
agent = "{{agent_name_1}}"
needs = ["spawn-agent-1"]
prompt = """
# {{track_name_1}} Agent Task

## Your Assignment

{{task_prompt_1}}

## Workflow Guidelines

1. Read any referenced files or specs before starting implementation
2. Write tests first when appropriate (TDD approach)
3. Implement the minimum code needed
4. Commit your changes with clear messages
5. If you discover related work needed, note it but do NOT implement it

## When Done

After completing your assigned task, run:

```
meow done
```
"""

[[main.steps]]
id = "review-1"
executor = "agent"
agent = "{{agent_name_1}}"
needs = ["work-1"]
prompt = """
# Self-Review: {{track_name_1}} Track

Take a step back and carefully reread your most recent code changes with fresh eyes.

## Review Checklist

1. **Read each file you modified** - look at the actual code, not your memory of it
2. **Check for obvious bugs** - nil pointer dereferences, off-by-one errors, typos
3. **Check for logical errors** - does the code actually do what it claims?
4. **Check for confusing patterns** - would another developer understand this?
5. **Verify test coverage** - do tests actually test the important behavior?
6. **Check imports** - any unused imports? Missing imports that will cause build failures?

## Actions

- Fix anything you spot without waiting for direction
- If you make fixes, commit them with message: "fix: self-review corrections for {{track_name_1}}"

## When Done

After reviewing and fixing any issues found, run:

```
meow done
```
"""

[[main.steps]]
id = "verify-clean-1"
executor = "agent"
agent = "{{agent_name_1}}"
needs = ["review-1"]
prompt = """
# Final Commit Check: {{track_name_1}} Track

Ensure ALL your changes are committed before this track completes.

## Steps

1. Run `git status` to check for any uncommitted changes
2. If there are uncommitted changes:
   - Stage them: `git add -A`
   - Commit with message: "chore: final changes for {{track_name_1}} track"
3. Run `git status` again to verify working directory is clean
4. Run `git log --oneline -5` to show recent commits

## Important

Do NOT proceed until `git status` shows a clean working directory.

When your working directory is clean, run:

```
meow done
```
"""

[[main.steps]]
id = "kill-agent-1"
executor = "kill"
agent = "{{agent_name_1}}"
needs = ["verify-clean-1"]
graceful = true

[[main.steps]]
id = "track-1-done"
executor = "shell"
command = "echo '{{track_name_1}} track complete'"
needs = ["kill-agent-1"]

# ============================================================================
# PHASE 2B: Agent 2 Lifecycle (runs in parallel with Agent 1)
# ============================================================================

[[main.steps]]
id = "spawn-agent-2"
executor = "spawn"
agent = "{{agent_name_2}}"
workdir = "{{create-worktree-2.outputs.path}}"
needs = ["create-worktree-2"]

[[main.steps]]
id = "work-2"
executor = "agent"
agent = "{{agent_name_2}}"
needs = ["spawn-agent-2"]
prompt = """
# {{track_name_2}} Agent Task

## Your Assignment

{{task_prompt_2}}

## Workflow Guidelines

1. Read any referenced files or specs before starting implementation
2. Write tests first when appropriate (TDD approach)
3. Implement the minimum code needed
4. Commit your changes with clear messages
5. If you discover related work needed, note it but do NOT implement it

## When Done

After completing your assigned task, run:

```
meow done
```
"""

[[main.steps]]
id = "review-2"
executor = "agent"
agent = "{{agent_name_2}}"
needs = ["work-2"]
prompt = """
# Self-Review: {{track_name_2}} Track

Take a step back and carefully reread your most recent code changes with fresh eyes.

## Review Checklist

1. **Read each file you modified** - look at the actual code, not your memory of it
2. **Check for obvious bugs** - nil pointer dereferences, off-by-one errors, typos
3. **Check for logical errors** - does the code actually do what it claims?
4. **Check for confusing patterns** - would another developer understand this?
5. **Verify test coverage** - do tests actually test the important behavior?
6. **Check imports** - any unused imports? Missing imports that will cause build failures?

## Actions

- Fix anything you spot without waiting for direction
- If you make fixes, commit them with message: "fix: self-review corrections for {{track_name_2}}"

## When Done

After reviewing and fixing any issues found, run:

```
meow done
```
"""

[[main.steps]]
id = "verify-clean-2"
executor = "agent"
agent = "{{agent_name_2}}"
needs = ["review-2"]
prompt = """
# Final Commit Check: {{track_name_2}} Track

Ensure ALL your changes are committed before this track completes.

## Steps

1. Run `git status` to check for any uncommitted changes
2. If there are uncommitted changes:
   - Stage them: `git add -A`
   - Commit with message: "chore: final changes for {{track_name_2}} track"
3. Run `git status` again to verify working directory is clean
4. Run `git log --oneline -5` to show recent commits

## Important

Do NOT proceed until `git status` shows a clean working directory.

When your working directory is clean, run:

```
meow done
```
"""

[[main.steps]]
id = "kill-agent-2"
executor = "kill"
agent = "{{agent_name_2}}"
needs = ["verify-clean-2"]
graceful = true

[[main.steps]]
id = "track-2-done"
executor = "shell"
command = "echo '{{track_name_2}} track complete'"
needs = ["kill-agent-2"]

# ============================================================================
# PHASE 3: Merge Agent Lifecycle (after both agents complete)
# ============================================================================

[[main.steps]]
id = "spawn-merge-agent"
executor = "spawn"
agent = "merge-agent"
workdir = "{{create-worktree-1.outputs.path}}"
needs = ["track-1-done", "track-2-done"]

[[main.steps]]
id = "merge-review"
executor = "agent"
agent = "merge-agent"
needs = ["spawn-merge-agent"]
prompt = """
# Review Agent: Dual Track Merge

You are the reviewer. Your job is to verify the implementation work from BOTH agents before merging to main.

## Branch Info

- Track 1 branch: {{create-worktree-1.outputs.branch}}
- Track 2 branch: {{create-worktree-2.outputs.branch}}

## Your Tasks

### 1. Review Track 1 Changes

```bash
cd /data/projects/meow-machine
git log --oneline main..{{create-worktree-1.outputs.branch}}
git diff --stat main..{{create-worktree-1.outputs.branch}}
```

### 2. Review Track 2 Changes

```bash
git log --oneline main..{{create-worktree-2.outputs.branch}}
git diff --stat main..{{create-worktree-2.outputs.branch}}
```

### 3. Check for Conflicts

See if the branches have overlapping changes:

```bash
git merge-tree $(git merge-base main {{create-worktree-1.outputs.branch}}) {{create-worktree-1.outputs.branch}} {{create-worktree-2.outputs.branch}} 2>&1 | head -50
```

### 4. Run Tests (if applicable)

```bash
go test ./... 2>&1 | tail -20
```

## When Done

After review is complete, run:

```
meow done
```
"""

[[main.steps]]
id = "merge-to-main"
executor = "agent"
agent = "merge-agent"
needs = ["merge-review"]
prompt = """
# Merge Both Tracks to Main

Reviews complete. Now merge both branches to main.

## Branch Info

- Track 1 branch: {{create-worktree-1.outputs.branch}}
- Track 2 branch: {{create-worktree-2.outputs.branch}}

## Steps

1. Go to main repo:
   ```bash
   cd /data/projects/meow-machine
   ```

2. Merge Track 1:
   ```bash
   git merge {{create-worktree-1.outputs.branch}} --no-edit -m "Merge: {{track_name_1}} track"
   ```

3. Merge Track 2:
   ```bash
   git merge {{create-worktree-2.outputs.branch}} --no-edit -m "Merge: {{track_name_2}} track"
   ```

4. Verify the merges:
   ```bash
   git log --oneline -10
   ```

5. Run tests:
   ```bash
   go test ./... 2>&1 | tail -20
   ```

## If Merge Conflicts

If there are merge conflicts:
1. List the conflicted files: `git status`
2. Resolve each conflict carefully
3. Stage resolved files: `git add <file>`
4. Complete the merge: `git commit`

## When Done

After successful merges, run:

```
meow done
```
"""

[[main.steps]]
id = "kill-merge-agent"
executor = "kill"
agent = "merge-agent"
needs = ["merge-to-main"]
graceful = true

[[main.steps]]
id = "workflow-done"
executor = "shell"
needs = ["kill-merge-agent"]
command = """
echo "=============================================="
echo "  DUAL AGENT WORKFLOW COMPLETE"
echo "=============================================="
echo "Both tracks merged to main:"
echo "  - {{track_name_1}}"
echo "  - {{track_name_2}}"
echo "=============================================="
"""
