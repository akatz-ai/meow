# ============================================================================
# MEOW Workflow: Quad Agent Task Runner (3 parallel + 1 integration)
# ============================================================================
#
# Three parallel agents work independently, then merge, then integration agent:
#   1. Create worktrees (serialized)
#   2. Agents 1-3 work in parallel: work → review → verify-clean → kill
#   3. Merge all 3 tracks into integration worktree
#   4. Agent 4 (integration): work → review → verify-clean → kill
#   5. Merge agent: review → merge to main → kill
#
# Usage:
#   meow run .meow/templates/quad-agent-task.meow.toml \
#     --var 'task_prompt_1=First agent task' \
#     --var 'task_prompt_2=Second agent task' \
#     --var 'task_prompt_3=Third agent task' \
#     --var 'task_prompt_4=Integration agent task'
#
# ============================================================================

[main]
name = "quad-agent-task"
description = "Three parallel agents + integration agent with full lifecycle"

[main.variables]
agent_name_1 = { default = "agent-1", description = "Name for first agent" }
track_name_1 = { default = "track-1", description = "Track name for first agent" }
task_prompt_1 = { required = true, description = "Task prompt for first agent" }

agent_name_2 = { default = "agent-2", description = "Name for second agent" }
track_name_2 = { default = "track-2", description = "Track name for second agent" }
task_prompt_2 = { required = true, description = "Task prompt for second agent" }

agent_name_3 = { default = "agent-3", description = "Name for third agent" }
track_name_3 = { default = "track-3", description = "Track name for third agent" }
task_prompt_3 = { required = true, description = "Task prompt for third agent" }

agent_name_4 = { default = "agent-4", description = "Name for integration agent" }
track_name_4 = { default = "integration", description = "Track name for integration agent" }
task_prompt_4 = { required = true, description = "Task prompt for integration agent" }

cleanup = """
echo "Cleaning up worktrees..."
git worktree remove .meow/worktrees/{{track_name_1}}-track --force 2>/dev/null || true
git worktree remove .meow/worktrees/{{track_name_2}}-track --force 2>/dev/null || true
git worktree remove .meow/worktrees/{{track_name_3}}-track --force 2>/dev/null || true
git worktree remove .meow/worktrees/{{track_name_4}}-track --force 2>/dev/null || true
echo "Cleanup complete"
"""

# ============================================================================
# PHASE 1: Create Worktrees (Serialized to avoid git conflicts)
# ============================================================================

[[main.steps]]
id = "create-worktree-1"
executor = "shell"
description = "Create worktree for {{track_name_1}}"
command = """
set -e
WORKTREE=".meow/worktrees/{{track_name_1}}-track"
BRANCH="{{track_name_1}}-track-$(date +%s)"
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }
branch = { source = "file:.meow/worktrees/{{track_name_1}}-track/.meow-branch" }

[[main.steps]]
id = "create-worktree-2"
executor = "shell"
description = "Create worktree for {{track_name_2}}"
needs = ["create-worktree-1"]
command = """
set -e
WORKTREE=".meow/worktrees/{{track_name_2}}-track"
BRANCH="{{track_name_2}}-track-$(date +%s)"
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }
branch = { source = "file:.meow/worktrees/{{track_name_2}}-track/.meow-branch" }

[[main.steps]]
id = "create-worktree-3"
executor = "shell"
description = "Create worktree for {{track_name_3}}"
needs = ["create-worktree-2"]
command = """
set -e
WORKTREE=".meow/worktrees/{{track_name_3}}-track"
BRANCH="{{track_name_3}}-track-$(date +%s)"
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }
branch = { source = "file:.meow/worktrees/{{track_name_3}}-track/.meow-branch" }

[[main.steps]]
id = "create-worktree-4"
executor = "shell"
description = "Create worktree for {{track_name_4}}"
needs = ["create-worktree-3"]
command = """
set -e
WORKTREE=".meow/worktrees/{{track_name_4}}-track"
BRANCH="{{track_name_4}}-track-$(date +%s)"
git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""
[main.steps.shell_outputs]
path = { source = "stdout" }
branch = { source = "file:.meow/worktrees/{{track_name_4}}-track/.meow-branch" }

# ============================================================================
# PHASE 2A: Agent 1 Lifecycle (parallel with 2 and 3)
# ============================================================================

[[main.steps]]
id = "spawn-agent-1"
executor = "spawn"
agent = "{{agent_name_1}}"
workdir = "{{create-worktree-1.outputs.path}}"
needs = ["create-worktree-1"]

[[main.steps]]
id = "work-1"
executor = "agent"
agent = "{{agent_name_1}}"
needs = ["spawn-agent-1"]
prompt = """
# {{track_name_1}} Agent Task

## FIRST: Read the Specification
Before doing ANY work, read the complete MEOW specification:

@docs/MVP-SPEC-v2.md

This is REQUIRED. The spec defines all types, executors, and patterns you must follow.

## Your Assignment

{{task_prompt_1}}

## IMPORTANT CONSTRAINTS
- **ONLY** implement the beads listed above
- Do NOT work on other beads you might see in `bd list`
- Do NOT modify files outside your assignment scope
- If you discover related work needed, note it but do NOT implement it

## Workflow
1. Run `bd show <bead-id>` for each bead to understand full requirements
2. Write tests first (TDD approach)
3. Implement the minimum code to pass tests
4. Commit after each bead with a clear message referencing the bead ID
5. Close beads as you complete them: `bd close <bead-id>`

## When Done
After ALL your assigned beads are implemented and closed, run:

```
meow done
```
"""

[[main.steps]]
id = "review-1"
executor = "agent"
agent = "{{agent_name_1}}"
needs = ["work-1"]
prompt = """
# Self-Review: {{track_name_1}} Track

Take a step back and carefully reread your most recent code changes with fresh eyes.

## Review Checklist
1. **Read each file you modified** - look at the actual code, not your memory of it
2. **Check for obvious bugs** - nil pointer dereferences, off-by-one errors, typos
3. **Check for logical errors** - does the code actually do what it claims?
4. **Verify test coverage** - do tests actually test the important behavior?
5. **Check imports** - any unused imports? Missing imports that will cause build failures?

## Actions
- Fix anything you spot without waiting for direction
- If you make fixes, commit them with message: "fix: self-review corrections for {{track_name_1}}"

## When Done
```
meow done
```
"""

[[main.steps]]
id = "verify-clean-1"
executor = "agent"
agent = "{{agent_name_1}}"
needs = ["review-1"]
prompt = """
# Final Commit Check: {{track_name_1}} Track

Ensure ALL your changes are committed.

## Steps
1. Run `git status` to check for uncommitted changes
2. If uncommitted: `git add -A && git commit -m "chore: final changes for {{track_name_1}}"`
3. Run `git status` again to verify clean
4. Run `git log --oneline -5` to show recent commits

When clean, run: `meow done`
"""

[[main.steps]]
id = "kill-agent-1"
executor = "kill"
agent = "{{agent_name_1}}"
needs = ["verify-clean-1"]
graceful = true

[[main.steps]]
id = "track-1-done"
executor = "shell"
command = "echo '{{track_name_1}} track complete'"
needs = ["kill-agent-1"]

# ============================================================================
# PHASE 2B: Agent 2 Lifecycle (parallel with 1 and 3)
# ============================================================================

[[main.steps]]
id = "spawn-agent-2"
executor = "spawn"
agent = "{{agent_name_2}}"
workdir = "{{create-worktree-2.outputs.path}}"
needs = ["create-worktree-2"]

[[main.steps]]
id = "work-2"
executor = "agent"
agent = "{{agent_name_2}}"
needs = ["spawn-agent-2"]
prompt = """
# {{track_name_2}} Agent Task

## FIRST: Read the Specification
Before doing ANY work, read the complete MEOW specification:

@docs/MVP-SPEC-v2.md

This is REQUIRED. The spec defines all types, executors, and patterns you must follow.

## Your Assignment

{{task_prompt_2}}

## IMPORTANT CONSTRAINTS
- **ONLY** implement the beads listed above
- Do NOT work on other beads you might see in `bd list`
- Do NOT modify files outside your assignment scope
- If you discover related work needed, note it but do NOT implement it

## Workflow
1. Run `bd show <bead-id>` for each bead to understand full requirements
2. Write tests first (TDD approach)
3. Implement the minimum code to pass tests
4. Commit after each bead with a clear message referencing the bead ID
5. Close beads as you complete them: `bd close <bead-id>`

## When Done
After ALL your assigned beads are implemented and closed, run:

```
meow done
```
"""

[[main.steps]]
id = "review-2"
executor = "agent"
agent = "{{agent_name_2}}"
needs = ["work-2"]
prompt = """
# Self-Review: {{track_name_2}} Track

Take a step back and carefully reread your most recent code changes with fresh eyes.

## Review Checklist
1. **Read each file you modified** - look at the actual code, not your memory of it
2. **Check for obvious bugs** - nil pointer dereferences, off-by-one errors, typos
3. **Check for logical errors** - does the code actually do what it claims?
4. **Verify test coverage** - do tests actually test the important behavior?
5. **Check imports** - any unused imports? Missing imports that will cause build failures?

## Actions
- Fix anything you spot without waiting for direction
- If you make fixes, commit them with message: "fix: self-review corrections for {{track_name_2}}"

## When Done
```
meow done
```
"""

[[main.steps]]
id = "verify-clean-2"
executor = "agent"
agent = "{{agent_name_2}}"
needs = ["review-2"]
prompt = """
# Final Commit Check: {{track_name_2}} Track

Ensure ALL your changes are committed.

## Steps
1. Run `git status` to check for uncommitted changes
2. If uncommitted: `git add -A && git commit -m "chore: final changes for {{track_name_2}}"`
3. Run `git status` again to verify clean
4. Run `git log --oneline -5` to show recent commits

When clean, run: `meow done`
"""

[[main.steps]]
id = "kill-agent-2"
executor = "kill"
agent = "{{agent_name_2}}"
needs = ["verify-clean-2"]
graceful = true

[[main.steps]]
id = "track-2-done"
executor = "shell"
command = "echo '{{track_name_2}} track complete'"
needs = ["kill-agent-2"]

# ============================================================================
# PHASE 2C: Agent 3 Lifecycle (parallel with 1 and 2)
# ============================================================================

[[main.steps]]
id = "spawn-agent-3"
executor = "spawn"
agent = "{{agent_name_3}}"
workdir = "{{create-worktree-3.outputs.path}}"
needs = ["create-worktree-3"]

[[main.steps]]
id = "work-3"
executor = "agent"
agent = "{{agent_name_3}}"
needs = ["spawn-agent-3"]
prompt = """
# {{track_name_3}} Agent Task

## FIRST: Read the Specification
Before doing ANY work, read the complete MEOW specification:

@docs/MVP-SPEC-v2.md

This is REQUIRED. The spec defines all types, executors, and patterns you must follow.

## Your Assignment

{{task_prompt_3}}

## IMPORTANT CONSTRAINTS
- **ONLY** implement the beads listed above
- Do NOT work on other beads you might see in `bd list`
- Do NOT modify files outside your assignment scope
- If you discover related work needed, note it but do NOT implement it

## Workflow
1. Run `bd show <bead-id>` for each bead to understand full requirements
2. Write tests first (TDD approach)
3. Implement the minimum code to pass tests
4. Commit after each bead with a clear message referencing the bead ID
5. Close beads as you complete them: `bd close <bead-id>`

## When Done
After ALL your assigned beads are implemented and closed, run:

```
meow done
```
"""

[[main.steps]]
id = "review-3"
executor = "agent"
agent = "{{agent_name_3}}"
needs = ["work-3"]
prompt = """
# Self-Review: {{track_name_3}} Track

Take a step back and carefully reread your most recent code changes with fresh eyes.

## Review Checklist
1. **Read each file you modified** - look at the actual code, not your memory of it
2. **Check for obvious bugs** - nil pointer dereferences, off-by-one errors, typos
3. **Check for logical errors** - does the code actually do what it claims?
4. **Verify test coverage** - do tests actually test the important behavior?
5. **Check imports** - any unused imports? Missing imports that will cause build failures?

## Actions
- Fix anything you spot without waiting for direction
- If you make fixes, commit them with message: "fix: self-review corrections for {{track_name_3}}"

## When Done
```
meow done
```
"""

[[main.steps]]
id = "verify-clean-3"
executor = "agent"
agent = "{{agent_name_3}}"
needs = ["review-3"]
prompt = """
# Final Commit Check: {{track_name_3}} Track

Ensure ALL your changes are committed.

## Steps
1. Run `git status` to check for uncommitted changes
2. If uncommitted: `git add -A && git commit -m "chore: final changes for {{track_name_3}}"`
3. Run `git status` again to verify clean
4. Run `git log --oneline -5` to show recent commits

When clean, run: `meow done`
"""

[[main.steps]]
id = "kill-agent-3"
executor = "kill"
agent = "{{agent_name_3}}"
needs = ["verify-clean-3"]
graceful = true

[[main.steps]]
id = "track-3-done"
executor = "shell"
command = "echo '{{track_name_3}} track complete'"
needs = ["kill-agent-3"]

# ============================================================================
# PHASE 3: Merge Parallel Tracks into Integration Worktree
# ============================================================================

[[main.steps]]
id = "merge-to-integration"
executor = "shell"
description = "Merge all 3 track branches into integration worktree"
needs = ["track-1-done", "track-2-done", "track-3-done", "create-worktree-4"]
command = """
set -e
cd {{create-worktree-4.outputs.path}}

BRANCH_1="{{create-worktree-1.outputs.branch}}"
BRANCH_2="{{create-worktree-2.outputs.branch}}"
BRANCH_3="{{create-worktree-3.outputs.branch}}"

echo "Merging $BRANCH_1..."
git merge "$BRANCH_1" --no-edit -m "Merge {{track_name_1}} track"

echo "Merging $BRANCH_2..."
git merge "$BRANCH_2" --no-edit -m "Merge {{track_name_2}} track"

echo "Merging $BRANCH_3..."
git merge "$BRANCH_3" --no-edit -m "Merge {{track_name_3}} track"

echo "All tracks merged into integration worktree"
git log --oneline -10
"""

# ============================================================================
# PHASE 4: Integration Agent Lifecycle (after merge)
# ============================================================================

[[main.steps]]
id = "spawn-agent-4"
executor = "spawn"
agent = "{{agent_name_4}}"
workdir = "{{create-worktree-4.outputs.path}}"
needs = ["merge-to-integration"]

[[main.steps]]
id = "work-4"
executor = "agent"
agent = "{{agent_name_4}}"
needs = ["spawn-agent-4"]
prompt = """
# {{track_name_4}} Agent Task (Integration)

## FIRST: Read the Specification
Before doing ANY work, read the complete MEOW specification:

@docs/MVP-SPEC-v2.md

This is REQUIRED. The spec defines all types, executors, and patterns you must follow.

## Context
You are working in the integration worktree which contains the merged work from:
- {{track_name_1}} track
- {{track_name_2}} track
- {{track_name_3}} track

Review what was implemented by running:
```bash
git log --oneline main..HEAD
```

## Your Assignment

{{task_prompt_4}}

## IMPORTANT CONSTRAINTS
- **ONLY** implement the beads listed above
- Do NOT work on other beads you might see in `bd list`
- You may need to integrate with code from the other tracks
- If you discover related work needed, note it but do NOT implement it

## Workflow
1. Run `bd show <bead-id>` for each bead to understand full requirements
2. Review the merged code from other tracks
3. Write tests first (TDD approach)
4. Implement the minimum code to pass tests
5. Commit after each bead with a clear message referencing the bead ID
6. Close beads as you complete them: `bd close <bead-id>`

## When Done
After ALL your assigned beads are implemented and closed, run:

```
meow done
```
"""

[[main.steps]]
id = "review-4"
executor = "agent"
agent = "{{agent_name_4}}"
needs = ["work-4"]
prompt = """
# Self-Review: {{track_name_4}} Track

Take a step back and carefully reread your most recent code changes with fresh eyes.

## Review Checklist
1. **Read each file you modified** - look at the actual code, not your memory of it
2. **Check for obvious bugs** - nil pointer dereferences, off-by-one errors, typos
3. **Check for logical errors** - does the code actually do what it claims?
4. **Verify test coverage** - do tests actually test the important behavior?
5. **Check imports** - any unused imports? Missing imports that will cause build failures?
6. **Check integration** - does your code properly integrate with the other tracks?

## Actions
- Fix anything you spot without waiting for direction
- If you make fixes, commit them with message: "fix: self-review corrections for {{track_name_4}}"

## When Done
```
meow done
```
"""

[[main.steps]]
id = "verify-clean-4"
executor = "agent"
agent = "{{agent_name_4}}"
needs = ["review-4"]
prompt = """
# Final Commit Check: {{track_name_4}} Track

Ensure ALL your changes are committed.

## Steps
1. Run `git status` to check for uncommitted changes
2. If uncommitted: `git add -A && git commit -m "chore: final changes for {{track_name_4}}"`
3. Run `git status` again to verify clean
4. Run `git log --oneline -5` to show recent commits

When clean, run: `meow done`
"""

[[main.steps]]
id = "kill-agent-4"
executor = "kill"
agent = "{{agent_name_4}}"
needs = ["verify-clean-4"]
graceful = true

[[main.steps]]
id = "track-4-done"
executor = "shell"
command = "echo '{{track_name_4}} track complete'"
needs = ["kill-agent-4"]

# ============================================================================
# PHASE 5: Final Merge Agent
# ============================================================================

[[main.steps]]
id = "spawn-merge-agent"
executor = "spawn"
agent = "merge-agent"
workdir = "{{create-worktree-4.outputs.path}}"
needs = ["track-4-done"]

[[main.steps]]
id = "merge-review"
executor = "agent"
agent = "merge-agent"
needs = ["spawn-merge-agent"]
prompt = """
# Final Review Agent

You are the final reviewer. Verify all implementation work before merging to main.

## FIRST: Read the Specification
@docs/MVP-SPEC-v2.md

## Review All Changes
```bash
git log --oneline main..HEAD
git diff --stat main..HEAD
```

## Run Tests
```bash
go test ./... 2>&1 | tail -30
```

All tests must pass before proceeding.

## Check for Issues
- Code that doesn't match the spec
- Missing error handling
- Incomplete implementations
- Dead code or unused imports

Fix small issues directly, document larger ones.

When done: `meow done`
"""

[[main.steps]]
id = "merge-to-main"
executor = "agent"
agent = "merge-agent"
needs = ["merge-review"]
prompt = """
# Merge to Main

All reviews complete. Merge the integration branch to main.

## Steps
```bash
cd /data/projects/meow-machine
BRANCH=$(cat {{create-worktree-4.outputs.path}}/.meow-branch)
git merge "$BRANCH" --no-edit -m "Merge: Adapter and Events system implementation"
git log --oneline -10
go test ./... 2>&1 | tail -20
```

## If Merge Conflicts
1. List conflicted files: `git status`
2. Resolve each conflict carefully
3. Stage: `git add <file>`
4. Complete: `git commit`

When done: `meow done`
"""

[[main.steps]]
id = "kill-merge-agent"
executor = "kill"
agent = "merge-agent"
needs = ["merge-to-main"]
graceful = true

[[main.steps]]
id = "workflow-done"
executor = "shell"
needs = ["kill-merge-agent"]
command = """
echo "=============================================="
echo "  QUAD AGENT WORKFLOW COMPLETE"
echo "=============================================="
echo "All tracks merged to main:"
echo "  - {{track_name_1}}"
echo "  - {{track_name_2}}"
echo "  - {{track_name_3}}"
echo "  - {{track_name_4}} (integration)"
echo "=============================================="
"""
