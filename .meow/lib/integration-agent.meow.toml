# ============================================================================
# MEOW Library: Integration Agent
# ============================================================================
#
# Merges multiple parallel tracks into an integration worktree.
# Unlike shell-based merging, this agent can resolve conflicts.
#
# WHY THIS EXISTS:
# When parallel agents work on the same files (e.g., adding tests to e2e_test.go),
# merge conflicts are expected. Shell scripts fail on conflicts. Agents can:
# - Detect conflicts from git output
# - Read conflict markers
# - Keep content from both branches
# - Complete the merge
#
# Variables:
#   workdir       (required) - Path to integration worktree
#   track_dirs    (required) - Comma-separated list of track directories
#                              e.g., "infra-track, timeout-tests-track"
#
# Usage:
#   [[main.steps]]
#   id = "integration"
#   executor = "expand"
#   template = "lib/integration-agent"
#   needs = ["track-1.done", "track-2.done", "worktree-integration.create"]
#   variables = {
#     workdir = "{{worktree-integration.create.outputs.path}}",
#     track_dirs = "track-1, track-2, track-3"
#   }
#
# ============================================================================

[main]
name = "integration-agent"
description = "Merge parallel tracks with conflict resolution"

[main.variables]
workdir = { required = true, description = "Path to integration worktree" }
track_dirs = { required = true, description = "Comma-separated track directory names" }

# ============================================================================
# Step 1: Spawn Integration Agent
# ============================================================================

[[main.steps]]
id = "spawn"
executor = "spawn"
agent = "agent-integration"
workdir = "{{workdir}}"

# ============================================================================
# Step 2: Merge All Tracks
# ============================================================================

[[main.steps]]
id = "work"
executor = "agent"
agent = "agent-integration"
needs = ["spawn"]
prompt = """
# Integration Agent: Merge All Tracks

Your job is to merge all feature branches into this integration worktree.
When parallel agents work on the same files, conflicts are expected. Resolve them.

## Tracks to Merge
{{track_dirs}}

For each track, the branch name is in `../<track-dir>/.meow-branch`

## Merge Each Branch
For each track:
```bash
BRANCH=$(cat ../<track-dir>/.meow-branch)
git merge "$BRANCH" --no-edit -m "Merge: <track-name>"
```

If the merge succeeds, continue to the next branch.

## If Conflicts Occur
When you see "CONFLICT" in the output:
1. Run `git status` to see conflicted files
2. For `.meow-branch` conflicts: just pick either version
   ```bash
   git checkout --theirs .meow-branch
   git add .meow-branch
   ```
3. For test file conflicts (e.g., `*_test.go`):
   - Both branches typically added content at the end
   - Keep BOTH sets of content (combine them)
   - Remove conflict markers (`<<<<<<<`, `=======`, `>>>>>>>`)
4. For other conflicts:
   - Read both versions carefully
   - Combine logically (don't lose either side's changes)
5. Stage resolved files: `git add <file>`
6. Complete the merge: `git commit -m "Merge: <track-name> (conflicts resolved)"`
7. Continue with the next branch

## After All Merges
1. Run `go build ./...` to verify build passes
2. Run `go test -short ./...` to verify tests pass
3. If tests fail, fix the issues and commit

When all tracks are merged and tests pass: `meow done`
"""

# ============================================================================
# Step 3: Review Integration
# ============================================================================

[[main.steps]]
id = "review"
executor = "agent"
agent = "agent-integration"
needs = ["work"]
prompt = """
# Integration Review

All tracks should be merged. Final verification:

1. `git log --oneline -20` - verify all merges present
2. `go build ./...` - verify build
3. `go test -short ./...` - verify tests

Fix any issues you find.

When verified: `meow done`
"""

# ============================================================================
# Step 4: Kill Integration Agent
# ============================================================================

[[main.steps]]
id = "kill"
executor = "kill"
agent = "agent-integration"
needs = ["review"]
graceful = true

# ============================================================================
# Step 5: Done Marker
# ============================================================================

[[main.steps]]
id = "done"
executor = "shell"
command = "echo 'Integration complete - all tracks merged successfully'"
needs = ["kill"]
