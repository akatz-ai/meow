# ═══════════════════════════════════════════════════════════════════════════════
# MEOW Library: Claude Utils
# ═══════════════════════════════════════════════════════════════════════════════
#
# Utility templates for Claude Code agent management:
#   - context-monitor: Watch context % and trigger /compact when needed
#   - send-compact: One-shot /compact injection
#   - send-escape: One-shot Escape key injection
#
# These work via tmux screen-scraping and key injection.
#
# ═══════════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════════
# CONTEXT MONITOR (Public Entry Point)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Monitors an agent's context usage and triggers /compact when above threshold.
# Runs as a simple shell loop (no recursive template expansion).
#
# Usage:
#   [[main.steps]]
#   id = "context-watch"
#   executor = "expand"
#   template = "lib/claude-utils#context-monitor"
#   variables = { agent = "worker", threshold = "85" }
#   needs = ["spawn-worker"]

[context-monitor]
name = "context-monitor"
description = "Monitor agent context and trigger /compact when above threshold"

[context-monitor.variables]
agent = { required = true, description = "Agent ID to monitor" }
threshold = { default = "85", description = "Context % to trigger compact (0-100)" }
check_interval = { default = "30", description = "Seconds between checks" }
max_iterations = { default = "100", description = "Max monitoring iterations before auto-exit (safety limit)" }

[[context-monitor.steps]]
id = "monitor-loop"
executor = "shell"
command = """
AGENT="{{agent}}"
THRESHOLD="{{threshold}}"
CHECK_INTERVAL="{{check_interval}}"
MAX_ITERATIONS="{{max_iterations}}"
SESSION="meow-${MEOW_WORKFLOW}-${AGENT}"
ITERATION=0

echo "Context monitor started for $SESSION (threshold: ${THRESHOLD}%, interval: ${CHECK_INTERVAL}s, max: ${MAX_ITERATIONS})"

while [ $ITERATION -lt $MAX_ITERATIONS ]; do
    ITERATION=$((ITERATION + 1))

    # Check if session exists
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "Session $SESSION no longer exists, monitor exiting (iteration $ITERATION)"
        exit 0
    fi

    # Screen-scrape context percentage from tmux
    # Claude Code shows context like: "123k/200k (61%)"
    PERCENT=$(tmux capture-pane -p -t "$SESSION" -S -100 2>/dev/null | \
        grep -oE '[0-9]+k/[0-9]+k \\([0-9]+%\\)' | tail -1 | \
        grep -oE '\\([0-9]+%\\)' | tr -d '()%')
    PERCENT="${PERCENT:-0}"

    # Check if above threshold
    if [ "$PERCENT" -ge "$THRESHOLD" ]; then
        echo "Context at ${PERCENT}% >= ${THRESHOLD}%, sending /compact (iteration $ITERATION)"
        # Send /compact to agent (use -l for literal mode, then Enter separately)
        tmux send-keys -t "$SESSION" -l "/compact"
        sleep 0.1
        tmux send-keys -t "$SESSION" Enter
        # Wait longer after compact to let it process
        sleep 60
    else
        # Normal check interval
        sleep "$CHECK_INTERVAL"
    fi
done

echo "Context monitor reached max iterations ($MAX_ITERATIONS), exiting"
"""


# ═══════════════════════════════════════════════════════════════════════════════
# CONTEXT MONITOR AGGRESSIVE (Public Entry Point)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Same as context-monitor but sends Escape before /compact to interrupt
# Claude mid-work. Use when you want to force compaction even if Claude
# is in the middle of something.

[context-monitor-aggressive]
name = "context-monitor-aggressive"
description = "Monitor context and compact aggressively (with Escape first)"

[context-monitor-aggressive.variables]
agent = { required = true, description = "Agent ID to monitor" }
threshold = { default = "85", description = "Context % to trigger compact (0-100)" }
check_interval = { default = "30", description = "Seconds between checks" }
max_iterations = { default = "100", description = "Max monitoring iterations before auto-exit (safety limit)" }

[[context-monitor-aggressive.steps]]
id = "monitor-loop"
executor = "shell"
command = """
AGENT="{{agent}}"
THRESHOLD="{{threshold}}"
CHECK_INTERVAL="{{check_interval}}"
MAX_ITERATIONS="{{max_iterations}}"
SESSION="meow-${MEOW_WORKFLOW}-${AGENT}"
ITERATION=0

echo "Context monitor (aggressive) started for $SESSION (threshold: ${THRESHOLD}%, interval: ${CHECK_INTERVAL}s, max: ${MAX_ITERATIONS})"

while [ $ITERATION -lt $MAX_ITERATIONS ]; do
    ITERATION=$((ITERATION + 1))

    # Check if session exists
    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "Session $SESSION no longer exists, monitor exiting (iteration $ITERATION)"
        exit 0
    fi

    # Screen-scrape context percentage from tmux
    PERCENT=$(tmux capture-pane -p -t "$SESSION" -S -100 2>/dev/null | \
        grep -oE '[0-9]+k/[0-9]+k \\([0-9]+%\\)' | tail -1 | \
        grep -oE '\\([0-9]+%\\)' | tr -d '()%')
    PERCENT="${PERCENT:-0}"

    # Check if above threshold
    if [ "$PERCENT" -ge "$THRESHOLD" ]; then
        echo "Context at ${PERCENT}% >= ${THRESHOLD}%, sending Escape + /compact (iteration $ITERATION)"
        # Send Escape first to interrupt Claude
        tmux send-keys -t "$SESSION" Escape
        sleep 0.5
        # Then send /compact (use -l for literal mode, then Enter separately)
        tmux send-keys -t "$SESSION" -l "/compact"
        sleep 0.1
        tmux send-keys -t "$SESSION" Enter
        # Wait longer after compact
        sleep 60
    else
        # Normal check interval
        sleep "$CHECK_INTERVAL"
    fi
done

echo "Context monitor reached max iterations ($MAX_ITERATIONS), exiting"
"""


# ═══════════════════════════════════════════════════════════════════════════════
# SEND COMPACT (Public Entry Point)
# ═══════════════════════════════════════════════════════════════════════════════
#
# One-shot: send /compact to an agent.
#
# Usage:
#   [[main.steps]]
#   id = "compact"
#   executor = "expand"
#   template = "lib/claude-utils#send-compact"
#   variables = { agent = "worker" }

[send-compact]
name = "send-compact"
description = "Send /compact command to an agent"

[send-compact.variables]
agent = { required = true, description = "Agent ID to send compact to" }

[[send-compact.steps]]
id = "inject"
executor = "agent"
agent = "{{agent}}"
prompt = "/compact"
mode = "fire_forget"


# ═══════════════════════════════════════════════════════════════════════════════
# SEND ESCAPE (Public Entry Point)
# ═══════════════════════════════════════════════════════════════════════════════
#
# One-shot: send Escape key to an agent to interrupt current operation.
#
# Usage:
#   [[main.steps]]
#   id = "interrupt"
#   executor = "expand"
#   template = "lib/claude-utils#send-escape"
#   variables = { agent = "worker" }

[send-escape]
name = "send-escape"
description = "Send Escape key to interrupt an agent"

[send-escape.variables]
agent = { required = true, description = "Agent ID to send escape to" }

[[send-escape.steps]]
id = "inject"
executor = "shell"
command = """
SESSION="meow-${MEOW_WORKFLOW}-{{agent}}"
tmux send-keys -t "$SESSION" Escape
"""
