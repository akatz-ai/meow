# ============================================================================
# MEOW Library: Agent Track Lifecycle
# ============================================================================
#
# Agent lifecycle framework: spawn → protocol → kill → done
# With Ralph Wiggum persistence monitor and context monitor running in parallel.
#
# The protocol defines the actual work. This template handles lifecycle only:
#   - Hook setup (for agent events)
#   - Agent spawn
#   - Parallel monitors (RW persistence, context monitor)
#   - Protocol expansion (delegates work to protocol template)
#   - Graceful shutdown
#
# ADAPTER SUPPORT:
#   Works with any adapter (claude, claude-opus, claude-sonnet, opencode, codex).
#   RW and context monitors only work with claude adapters (require hooks/screen-scraping).
#   For non-claude adapters, these monitors are automatically disabled.
#
# Variables:
#   agent_name   (required) - Unique agent identifier
#   track_name   (required) - Track name for logging/identification
#   workdir      (required) - Working directory (typically a worktree path)
#   task         (required) - Task object passed to protocol (contains task_system, task_ids, etc.)
#   protocol     (default: "tdd") - Protocol template to expand (tdd, code-review, explorer, security-audit)
#   adapter      (default: "claude") - Agent adapter (claude, claude-opus, claude-sonnet, opencode, codex)
#   spawn_args   (default: "") - Extra CLI args passed to agent
#   enable_rw    (default: "true") - Enable Ralph Wiggum persistence monitor (claude only)
#   max_nudges   (default: "10") - RW safety limit before force-completing
#   enable_context_monitor (default: "true") - Enable context usage auto-compact (claude only)
#   context_threshold (default: "80") - Context % to trigger /compact
#
# Usage:
#   [[main.steps]]
#   id = "worker-1"
#   executor = "expand"
#   template = "lib/agent-track"
#   variables = {
#     agent_name = "agent-1",
#     track_name = "feature-x",
#     workdir = "{{setup-worktree.create.outputs.path}}",
#     task = "{{task}}",
#     protocol = "tdd",
#     adapter = "claude-opus"
#   }
#
# ============================================================================

[main]
name = "agent-track"
description = "Agent lifecycle framework - protocol defines the work"

[main.variables]
agent_name = { required = true, description = "Unique agent identifier" }
track_name = { required = true, description = "Track name for identification" }
workdir = { required = true, description = "Working directory path" }
task = { required = true, description = "Task object passed to protocol" }
protocol = { default = "tdd", description = "Protocol to expand (tdd, code-review, explorer, security-audit)" }
adapter = { default = "claude", description = "Agent adapter (claude, claude-opus, claude-sonnet, opencode, codex)" }
spawn_args = { default = "", description = "Extra CLI args passed to agent" }
enable_rw = { default = "true", description = "Enable Ralph Wiggum persistence monitor (claude adapters only)" }
max_nudges = { default = "10", description = "Max nudges before force-completing (Ralph Wiggum safety limit)" }
enable_context_monitor = { default = "true", description = "Enable context usage monitor with auto-compact (claude adapters only)" }
context_threshold = { default = "80", description = "Context % to trigger auto-compact (0-100)" }

# ============================================================================
# Step 1: Setup Hooks (for agent-stopped events, claude adapters only)
# ============================================================================

[[main.steps]]
id = "setup-hooks"
executor = "branch"
condition = "echo '{{adapter}}' | grep -q '^claude'"

[main.steps.on_true]
template = "lib/claude-events#setup-stop-hook"
variables = { worktree = "{{workdir}}" }

[main.steps.on_false]
inline = [{ id = "skip", executor = "shell", command = "echo 'Hooks not available for {{adapter}} adapter - RW monitor will be disabled'" }]

# ============================================================================
# Step 2: Spawn Agent
# ============================================================================

[[main.steps]]
id = "spawn"
executor = "spawn"
agent = "{{agent_name}}"
adapter = "{{adapter}}"
workdir = "{{workdir}}"
spawn_args = "{{spawn_args}}"
needs = ["setup-hooks"]

# ============================================================================
# Step 3: Ralph Wiggum Persistence Monitor (runs in parallel, claude only)
# ============================================================================
#
# Monitors for unexpected agent stops and re-injects nudge prompts.
# Runs in parallel with protocol steps.
# Self-terminates when the protocol step completes.
# Only works with claude adapters (requires Stop hook events).
# Disable with enable_rw = "false"

[[main.steps]]
id = "persistence"
executor = "branch"
condition = "test '{{enable_rw}}' = 'true' && echo '{{adapter}}' | grep -q '^claude'"
needs = ["spawn"]

[main.steps.on_true]
template = "lib/agent-persistence#monitor"
variables = { agent = "{{agent_name}}", check_step = "protocol", max_loops = "{{max_nudges}}", nudge_prompt = "You stopped unexpectedly. Continue with your assigned task for {{track_name}}.\n\nWhen fully done, run: `meow done`" }

[main.steps.on_false]
inline = [{ id = "skip", executor = "shell", command = "echo 'RW persistence monitor skipped (enable_rw={{enable_rw}}, adapter={{adapter}})'" }]

# ============================================================================
# Step 4: Context Monitor (runs in parallel, claude only)
# ============================================================================
#
# Monitors agent context usage and auto-compacts when above threshold.
# Runs in parallel with protocol steps.
# Self-terminates when agent tmux session is killed.
# Only works with claude adapters (screen-scrapes claude-specific format).
# Disable with enable_context_monitor = "false"

[[main.steps]]
id = "context-monitor"
executor = "branch"
condition = "test '{{enable_context_monitor}}' = 'true' && echo '{{adapter}}' | grep -q '^claude'"
needs = ["spawn"]

[main.steps.on_true]
template = "lib/claude-utils#context-monitor"
variables = { agent = "{{agent_name}}", threshold = "{{context_threshold}}" }

[main.steps.on_false]
inline = [
  { id = "skip", executor = "shell", command = "echo 'Context monitor skipped (enable_context_monitor={{enable_context_monitor}}, adapter={{adapter}})'" }
]

# ============================================================================
# Step 5: Protocol (the main work - delegates to protocol template)
# ============================================================================
#
# The protocol template defines the actual work steps.
# This is the core change: instead of hardcoding work/review steps,
# we expand a protocol template that defines the workflow personality.
#
# Available protocols:
#   - tdd: Test-Driven Development (default)
#   - code-review: Code review workflow
#   - explorer: Codebase exploration
#   - security-audit: Security audit workflow

[[main.steps]]
id = "protocol"
executor = "expand"
template = "lib/protocols/{{protocol}}"
needs = ["spawn"]

[main.steps.variables]
agent = "{{agent_name}}"
track_name = "{{track_name}}"
task = "{{task}}"

# ============================================================================
# Step 6: Kill Agent
# ============================================================================

[[main.steps]]
id = "kill"
executor = "kill"
agent = "{{agent_name}}"
needs = ["protocol"]
graceful = true

# ============================================================================
# Step 7: Done Marker (for downstream dependencies)
# ============================================================================

[[main.steps]]
id = "done"
executor = "shell"
command = "echo '{{track_name}} track complete'"
needs = ["kill"]
