# Integration Protocol - Merge parallel branches and verify
#
# Used by sprint workflow to merge all track branches into target.
# This is NOT for implementing features - it's for merging completed work.
#
# Task Schema:
#   task.target_branch - Branch to merge into (e.g., "main")
#   task.tracks_file   - Path to enriched tasks JSON (optional, defaults to ../.enriched-tasks.json)
#
# The agent runs in the integration worktree and merges branches from sibling worktrees.

[main]
name = "integration-protocol"
description = "Merge parallel branches with conflict resolution"

[main.variables]
agent = { required = true, description = "Agent ID" }
track_name = { required = true, description = "Track name for logging" }
task = { required = true, description = "Task object with target_branch" }

# Step 1: Merge all branches
[[main.steps]]
id = "merge"
executor = "agent"
agent = "{{agent}}"
prompt = """
# Integration: Merge All Sprint Tracks

You are inside the integration worktree. Your job is to merge all feature branches.

## Locate Sprint Metadata

```bash
# The enriched tasks file is in the parent worktrees directory
WORKTREES_DIR="$(dirname "$PWD")"
TASKS_FILE="$WORKTREES_DIR/.enriched-tasks.json"
TARGET_BRANCH=$(cat "$WORKTREES_DIR/.target-branch" 2>/dev/null || echo "main")

echo "Worktrees dir: $WORKTREES_DIR"
echo "Tasks file: $TASKS_FILE"
echo "Target branch: $TARGET_BRANCH"

# List branches to merge
cat "$TASKS_FILE" | jq -r '.[] | "\\(.name): \\(.branch)"'
```

## Merge Each Branch

For each track in the enriched tasks file:

```bash
for row in $(jq -c '.[]' "$TASKS_FILE"); do
  NAME=$(echo "$row" | jq -r '.name')
  BRANCH=$(echo "$row" | jq -r '.branch')
  echo "Merging $NAME ($BRANCH)..."
  git merge "$BRANCH" --no-edit -m "Merge: $NAME-track"
done
```

## If Conflicts Occur

When you see "CONFLICT" in the output:
1. Run `git status` to see conflicted files
2. For test file conflicts:
   - Both branches typically added content at the end
   - Keep BOTH sets of content (combine them)
   - Remove conflict markers (`<<<<<<<`, `=======`, `>>>>>>>`)
3. For other conflicts:
   - Read both versions carefully
   - Combine logically (don't lose either side's changes)
4. Stage resolved files: `git add <file>`
5. Complete the merge: `git commit -m "Merge: <track-name> (conflicts resolved)"`
6. Continue with the next branch

When all branches are merged: `meow done`
"""

# Step 2: Verify build and tests
[[main.steps]]
id = "verify"
executor = "agent"
agent = "{{agent}}"
needs = ["merge"]
prompt = """
# Integration: Verify Build and Tests

All branches should be merged. Now verify everything works.

## Run Verification

Check CLAUDE.md or AGENTS.md for project-specific build/test commands, then:

1. **Build**: Run the project's build command
2. **Test**: Run the project's test command
3. **Fix**: If anything fails, fix it and commit

## Update Local Target Branch

After verification passes:

```bash
WORKTREES_DIR="$(dirname "$PWD")"
TARGET_BRANCH=$(cat "$WORKTREES_DIR/.target-branch" 2>/dev/null || echo "main")

# Update local target branch to point to current HEAD (with all merges)
git branch -f "$TARGET_BRANCH" HEAD
echo "Updated $TARGET_BRANCH to $(git rev-parse --short HEAD)"
```

**IMPORTANT**: Do NOT push to remote. This is a local-only workflow.

When verified and target branch updated: `meow done`
"""

# Step 3: Final review
[[main.steps]]
id = "review"
executor = "agent"
agent = "{{agent}}"
needs = ["verify"]
prompt = """
# Integration: Final Review

Quick sanity check before we're done:

```bash
WORKTREES_DIR="$(dirname "$PWD")"
TARGET_BRANCH=$(cat "$WORKTREES_DIR/.target-branch" 2>/dev/null || echo "main")
```

1. `git log --oneline -20` - verify all merge commits present
2. `git status` - should be clean (no uncommitted changes)
3. Verify target branch was updated:
   ```bash
   INTEGRATION_HEAD=$(git rev-parse HEAD)
   TARGET_HEAD=$(git rev-parse "$TARGET_BRANCH")
   [ "$INTEGRATION_HEAD" = "$TARGET_HEAD" ] && echo "✓ $TARGET_BRANCH updated" || echo "✗ Run: git branch -f $TARGET_BRANCH HEAD"
   ```

If anything is wrong, fix it now.

When everything checks out: `meow done`
"""
