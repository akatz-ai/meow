# Security Audit Protocol - Security-focused code review
#
# Focuses on OWASP Top 10 and common security vulnerabilities.
# Does NOT fix issues - documents them for later remediation.

[main]
name = "security-audit-protocol"
description = "Security vulnerability audit"

[main.variables]
agent = { required = true, description = "Agent ID" }
track_name = { required = true, description = "Track name for logging" }
task = { required = true, description = "Task object with audit scope" }

# Step 1: Map attack surface
[[main.steps]]
id = "map-surface"
executor = "agent"
agent = "{{agent}}"
prompt = """
# Security Audit: {{track_name}}

## Your Assignment

Audit: {{task.task_system}}: {{task.task_ids}}

## Phase 1: Map Attack Surface

Identify potential entry points and data flows:

1. **Input sources**
   - User inputs (forms, API params, file uploads)
   - External API calls
   - Configuration files
   - Environment variables

2. **Data flows**
   - Where does sensitive data go?
   - What transformations occur?
   - Where is data stored?

3. **Authentication/Authorization**
   - How are users authenticated?
   - How are permissions checked?
   - Where are secrets stored?

4. **External dependencies**
   - Third-party libraries
   - External services
   - Database connections

Create a mental map of what to audit.

When attack surface is mapped: `meow done`
"""

# Step 2: Vulnerability scan
[[main.steps]]
id = "scan-vulnerabilities"
executor = "agent"
agent = "{{agent}}"
needs = ["map-surface"]
prompt = """
# Phase 2: Vulnerability Scan

Check for OWASP Top 10 and common vulnerabilities:

## OWASP Top 10 Checklist

1. **Injection** (SQL, Command, LDAP, XPath)
   - Are inputs sanitized?
   - Are parameterized queries used?
   - Is user input used in shell commands?

2. **Broken Authentication**
   - Weak password policies?
   - Session management issues?
   - Credential storage (plaintext, weak hashing)?

3. **Sensitive Data Exposure**
   - Encryption at rest and in transit?
   - Sensitive data in logs?
   - Hardcoded secrets?

4. **XML External Entities (XXE)**
   - XML parsing with external entities enabled?

5. **Broken Access Control**
   - Authorization checks on all endpoints?
   - Privilege escalation possible?
   - IDOR vulnerabilities?

6. **Security Misconfiguration**
   - Debug mode in production?
   - Default credentials?
   - Unnecessary features enabled?

7. **Cross-Site Scripting (XSS)**
   - Output encoding?
   - User content rendered unsafely?

8. **Insecure Deserialization**
   - Untrusted data deserialized?

9. **Using Components with Known Vulnerabilities**
   - Check dependencies for CVEs
   - Outdated packages?

10. **Insufficient Logging & Monitoring**
    - Security events logged?
    - Logs protected from tampering?

## For Each Finding

Document:
- Location (file:line)
- Vulnerability type
- Severity: Critical/High/Medium/Low
- Exploitation scenario
- Recommended remediation

Create beads for significant findings (map severity to priority):
```bash
# Critical → P0, High → P1, Medium → P2, Low → P3
bd create --title="Security: <vuln-type> in <location>" --type=bug --priority=<0-3> --notes="
Location: <file:line>
Severity: <Critical/High/Medium/Low>
Type: <vuln-type>

Exploitation: <how it could be exploited>

Remediation: <recommended fix>
"
```

When scan is complete: `meow done`
"""

# Step 3: Create report
[[main.steps]]
id = "create-report"
executor = "agent"
agent = "{{agent}}"
needs = ["scan-vulnerabilities"]
prompt = """
# Phase 3: Security Report

Create a formal security audit report:

## Report Format

```markdown
# Security Audit Report: {{track_name}}

## Executive Summary
[High-level findings for stakeholders]

## Scope
[What was audited]

## Methodology
[OWASP Top 10, manual review, etc.]

## Findings Summary
| Severity | Count |
|----------|-------|
| Critical | X     |
| High     | X     |
| Medium   | X     |
| Low      | X     |

## Critical Findings
[Detailed list with remediation]

## High Severity Findings
[Detailed list]

## Medium Severity Findings
[Brief list]

## Low Severity Findings
[Brief list]

## Recommendations
[Prioritized remediation plan]

## Created Beads
[Links to beads created for tracking]
```

Save to: `docs/security-audit-{{track_name}}.md`

Commit:
```bash
git add docs/security-audit-{{track_name}}.md
git commit -m "docs: security audit report for {{track_name}}"
```

When report is complete: `meow done`
"""
