# ============================================================================
# MEOW Protocol: Code Review
# ============================================================================
#
# Code review protocol for agents that review existing code without making changes.
# This demonstrates the protocol system's flexibility - agents read and document
# issues rather than implementing.
#
# Use this for:
#   - PR reviews
#   - Security audits (use security-audit for more focused review)
#   - Architecture reviews
#   - Code quality assessments
#
# Variables:
#   agent (required) - Agent ID
#   track_name (required) - Track name for logging
#   task (required) - Task object with review_scope or files to review
#
# Usage:
#   [[main.steps]]
#   id = "review-track"
#   executor = "expand"
#   template = "lib/protocols/code-review"
#   variables = {
#     agent = "reviewer-1",
#     track_name = "pr-123-review",
#     task = { task_system = "bd", task_ids = "meow-xyz" }
#   }
#
# ============================================================================

[main]
name = "code-review-protocol"
description = "Code review and documentation protocol"

[main.variables]
agent = { required = true, description = "Agent ID" }
track_name = { required = true, description = "Track name for logging" }
task = { required = true, description = "Task object with review scope" }

# ============================================================================
# Step 1: Explore the code
# ============================================================================

[[main.steps]]
id = "explore"
executor = "agent"
agent = "{{agent}}"
prompt = """
# Code Review: {{track_name}}

## Your Assignment

Review the following:
{{task.task_system}}: {{task.task_ids}}

## Phase 1: Exploration

1. Read and understand the code thoroughly
   - For beads: `bd show <bead-id>` to understand context
   - Navigate to referenced files
   - Understand the architecture and flow

2. Take notes on:
   - What the code does
   - How it's structured
   - Any initial concerns

**Important**: Do NOT make any changes yet. This is exploration only.

When you understand the code: `meow done`
"""

# ============================================================================
# Step 2: Identify issues
# ============================================================================

[[main.steps]]
id = "identify-issues"
executor = "agent"
agent = "{{agent}}"
needs = ["explore"]
prompt = """
# Phase 2: Identify Issues

Now that you understand the code, systematically identify issues:

## Categories to Check

1. **Logic errors** - Does the code do what it claims?
2. **Edge cases** - What inputs might break it?
3. **Error handling** - Are errors caught and handled properly?
4. **Performance** - Any obvious inefficiencies?
5. **Security** - Any vulnerabilities? (input validation, injection, etc.)
6. **Code style** - Consistency, naming, clarity
7. **Test coverage** - Are the tests adequate?

## For Each Issue Found

Document with:
- File and line number
- Issue description
- Severity: Critical / Major / Minor
- Suggested fix (if obvious)

Create beads for significant issues:
```bash
bd create --title="Issue: <description>" --type=bug --priority=2 --notes="Found during code review of {{track_name}}"
```

**Important**: Do NOT fix issues. Document only.

When issue identification is complete: `meow done`
"""

# ============================================================================
# Step 3: Create summary
# ============================================================================

[[main.steps]]
id = "summarize"
executor = "agent"
agent = "{{agent}}"
needs = ["identify-issues"]
prompt = """
# Phase 3: Create Review Summary

Create a summary of your findings:

## Summary Format

Create or update a file with your review:

```markdown
# Code Review: {{track_name}}

## Overview
- Files reviewed: [list]
- Review date: [date]

## Summary
[Brief overview of code quality]

## Critical Issues
[List any critical issues]

## Major Issues
[List major issues]

## Minor Issues
[List minor issues]

## Recommendations
[Actionable recommendations]

## Created Beads
[List any beads created during review]
```

Commit your summary:
`git commit -m "docs: code review summary for {{track_name}}"`

When summary is complete: `meow done`
"""
