# ============================================================================
# MEOW Workflow: Sprint
# ============================================================================
#
# Agent sprint workflow for parallel or sequential task execution.
#
# This workflow:
#   1. Creates worktrees for each task (serialized for git safety)
#   2. Spawns agents (parallel or sequential based on `parallel` variable)
#   3. Waits for all agents to complete
#   4. Merges all branches into integration worktree
#   5. Merges to target branch (or pushes for PR)
#
# USAGE:
#
#   # Basic usage with beads task system:
#   meow run sprint --var tasks='[{"name":"impl","beads":["meow-el7q","meow-a2ht"]}]'
#
#   # Multiple parallel agents:
#   meow run sprint --var tasks='[
#     {"name":"track1","beads":["meow-el7q","meow-a2ht"]},
#     {"name":"track2","beads":["meow-u7iu","meow-ap08"]}
#   ]'
#
#   # Sequential mode - one agent at a time:
#   meow run sprint --var tasks='[...]' --var parallel=false
#
#   # With adapter selection for implementation agents:
#   meow run sprint --var tasks='[...]' --var adapter=claude-opus
#
#   # With opencode adapter (RW/context monitors disabled automatically):
#   meow run sprint --var tasks='[...]' --var adapter=opencode
#
#   # Override merge/integration agent adapter (default: opencode):
#   meow run sprint --var tasks='[...]' --var merge_adapter=claude-opus
#
# TASK FORMAT:
#
#   JSON array where each object has:
#     - name: string (track name, used for worktree/branch naming)
#     - <task_system>: array of task IDs
#
#   The task system key (e.g., "beads", "jira", "linear") tells the agent
#   which system to query for full task details.
#
#   Examples:
#     # Beads task system
#     [{"name": "impl", "beads": ["meow-el7q", "meow-a2ht"]}]
#
#     # Jira task system (future)
#     [{"name": "impl", "jira": ["PROJ-123", "PROJ-456"]}]
#
#   The agent will be told "You've been assigned <task_system>: <ids>"
#   and should use CLAUDE.md for instructions on interacting with that system.
#
# ADAPTERS:
#
#   Available adapters (see .meow/adapters/):
#     - claude          Default Claude Code (opus)
#     - claude-opus     Claude Code with Opus model
#     - claude-sonnet   Claude Code with Sonnet model
#     - claude-haiku    Claude Code with Haiku model
#     - opencode        OpenCode CLI
#     - codex           Codex CLI
#
#   Note: RW persistence and context monitors only work with claude-* adapters.
#
# SEE ALSO:
#
#   - lib/sprint-common: Shared templates for setup, integration, cleanup
#   - lib/agent-track: Single agent lifecycle template
#
# ============================================================================

[main]
name = "sprint"
description = "Agent sprint workflow (parallel or sequential)"

[main.variables]
tasks = { required = true, description = "JSON array of task assignments: [{name, <task_system>: [ids]}]" }
parallel = { default = "true", description = "Run agents in parallel (true) or sequential (false)" }
target_branch = { default = "main", description = "Target branch for final merge" }
skip_merge_to_target = { default = "false", description = "If true, push branch for PR instead of merging" }
spawn_args = { default = "", description = "Extra CLI args for spawned agents" }
adapter = { default = "claude", description = "Agent adapter for implementation agents (claude, claude-opus, claude-sonnet, opencode, codex)" }
merge_adapter = { default = "opencode", description = "Agent adapter for integration/merge agent (opencode, claude, claude-opus, codex)" }
enable_rw = { default = "true", description = "Enable Ralph Wiggum persistence monitor (claude adapters only)" }
max_nudges = { default = "10", description = "Max RW nudges before force-completing agent" }
enable_context_monitor = { default = "true", description = "Enable context usage auto-compact (claude adapters only)" }
context_threshold = { default = "70", description = "Context % to trigger auto-compact (0-100)" }

# Cleanup is opt-in. Only runs on success - preserves worktrees on failure for debugging.
cleanup_on_success = """
echo "Cleaning up sprint worktrees..."

# Parse task names from enriched file and remove each worktree
for name in $(jq -r '.[].name' .meow/worktrees/.enriched-tasks.json 2>/dev/null || echo ""); do
  git worktree remove ".meow/worktrees/${name}-track" --force 2>/dev/null || rm -rf ".meow/worktrees/${name}-track"
done

# Remove integration worktree
git worktree remove .meow/worktrees/sprint-integration-track --force 2>/dev/null || rm -rf .meow/worktrees/sprint-integration-track

# Clean up temp files
rm -f .meow/worktrees/.enriched-tasks.json .meow/worktrees/.tasks.json .meow/worktrees/.track-dirs .meow/worktrees/.integration-path

echo "Cleanup complete"
"""

# ============================================================================
# PHASE 1: Setup - Create Worktrees
# ============================================================================

[[main.steps]]
id = "setup"
executor = "expand"
template = "lib/sprint-common#setup"
description = "Create worktrees and prepare enriched task list"

[main.steps.variables]
tasks = "{{tasks}}"

# ============================================================================
# PHASE 2: Agent Tracks (foreach)
# ============================================================================
#
# Uses foreach to process tasks. Set parallel=true (default) for concurrent
# execution or parallel=false for sequential (one at a time).

[[main.steps]]
id = "agents"
executor = "foreach"
items_file = ".meow/worktrees/.enriched-tasks.json"
item_var = "task"
index_var = "i"
template = "lib/sprint-common#agent-track-wrapper"
parallel = "{{parallel}}"
needs = ["setup.done"]

[main.steps.variables]
adapter = "{{adapter}}"
spawn_args = "{{spawn_args}}"
enable_rw = "{{enable_rw}}"
max_nudges = "{{max_nudges}}"
enable_context_monitor = "{{enable_context_monitor}}"
context_threshold = "{{context_threshold}}"

# ============================================================================
# PHASE 3: Integration (Merge all branches directly to target)
# ============================================================================

[[main.steps]]
id = "integration"
executor = "expand"
template = "lib/sprint-common#integration"
needs = ["agents"]

[main.steps.variables]
spawn_args = "{{spawn_args}}"
merge_adapter = "{{merge_adapter}}"
target_branch = "{{target_branch}}"
skip_merge_to_target = "{{skip_merge_to_target}}"
enable_rw = "{{enable_rw}}"
max_nudges = "{{max_nudges}}"

# ============================================================================
# PHASE 4: Done
# ============================================================================

[[main.steps]]
id = "workflow-done"
executor = "expand"
template = "lib/sprint-common#summary"
needs = ["integration.done"]

[main.steps.variables]
target_branch = "{{target_branch}}"
skip_merge_to_target = "{{skip_merge_to_target}}"
