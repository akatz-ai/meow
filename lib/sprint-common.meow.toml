# ============================================================================
# MEOW Library: Sprint Common Templates
# ============================================================================
#
# Shared templates for sprint workflows (parallel and sequential).
# These templates handle worktree setup, integration, and agent track wrapping.
#
# Available templates:
#   - setup: Creates worktrees and enriches task list
#   - integration: Merges all task branches
#   - agent-track-wrapper: Wraps lib/agent-track with spec handling
#
# ============================================================================


# ============================================================================
# SETUP (Public)
# ============================================================================
#
# Creates worktrees for each task and an integration worktree.
# Outputs enriched task list with workdir paths.
#
# Variables:
#   tasks (required) - JSON content of [{name, prompt}] task objects (parent reads file)
#
# Outputs (via files):
#   .meow/worktrees/.enriched-tasks.json - Tasks with workdir/branch added
#   .meow/worktrees/.track-dirs - Comma-separated list of track directories
#   .meow/worktrees/.integration-path - Path to integration worktree
#
# Usage:
#   [[main.steps]]
#   id = "setup"
#   executor = "expand"
#   template = "lib/sprint-common#setup"
#   variables = { tasks = "{{tasks}}" }

[setup]
name = "sprint-setup"
description = "Create worktrees and prepare enriched task list"

[setup.variables]
# Note: Parent template reads the file, so we receive the content here (not the path)
tasks = { required = true, description = "JSON array of [{name, prompt}] task objects" }

[[setup.steps]]
id = "create-worktrees"
executor = "shell"
description = "Create worktrees for each task"
command = """
set -e
mkdir -p .meow/worktrees

# Write tasks to temp file to avoid shell quoting issues with embedded newlines
cat > .meow/worktrees/.tasks.json << 'TASKS_EOF'
{{tasks}}
TASKS_EOF

# Parse the tasks JSON array from file
TASK_COUNT=$(jq 'length' .meow/worktrees/.tasks.json)

if [ "$TASK_COUNT" -eq 0 ]; then
  echo "ERROR: No tasks provided" >&2
  exit 1
fi

echo "Creating $TASK_COUNT worktrees..." >&2

# Build enriched tasks array with workdir paths
ENRICHED='[]'
TRACK_DIRS=''

for i in $(seq 0 $((TASK_COUNT - 1))); do
  # Extract task fields from file (avoid extracting prompt to shell variable - newlines break things)
  NAME=$(jq -r ".[$i].name" .meow/worktrees/.tasks.json)
  BEADS=$(jq -r ".[$i].beads // empty" .meow/worktrees/.tasks.json)

  # Validate name
  if [ -z "$NAME" ] || [ "$NAME" = "null" ]; then
    echo "ERROR: Task $i missing 'name' field" >&2
    exit 1
  fi

  # Create worktree
  WORKTREE=".meow/worktrees/${NAME}-track"
  BRANCH="${NAME}-track-$(date +%s)"

  # Clean up any existing worktree
  if [ -d "$WORKTREE" ]; then
    echo "  Cleaning up existing worktree: $WORKTREE" >&2
    git worktree remove "$WORKTREE" --force 2>/dev/null || rm -rf "$WORKTREE"
  fi

  echo "  Creating worktree: $WORKTREE ($BRANCH)" >&2
  git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
  echo "$BRANCH" > "$WORKTREE/.meow-branch"

  # Add to enriched array - read prompt directly from file to avoid shell escaping issues
  # The prompt never goes through a shell variable, staying safely in jq's domain
  # Note: use printf|jq instead of jq<<<VAR because sh doesn't support here-strings
  ENRICHED=$(printf '%s' "$ENRICHED" | jq -c \
    --arg name "$NAME" \
    --arg beads "$BEADS" \
    --arg workdir "$WORKTREE" \
    --arg branch "$BRANCH" \
    --argjson index "$i" \
    --slurpfile tasks .meow/worktrees/.tasks.json \
    '. + [{
      "name": $name,
      "prompt": $tasks[0][$index].prompt,
      "beads": $beads,
      "workdir": $workdir,
      "branch": $branch,
      "index": $index
    }]')

  # Build track_dirs string for integration agent
  if [ -z "$TRACK_DIRS" ]; then
    TRACK_DIRS="${NAME}-track"
  else
    TRACK_DIRS="${TRACK_DIRS}, ${NAME}-track"
  fi
done

# Create integration worktree
INT_WORKTREE=".meow/worktrees/sprint-integration-track"
INT_BRANCH="sprint-integration-track-$(date +%s)"

if [ -d "$INT_WORKTREE" ]; then
  echo "  Cleaning up existing integration worktree" >&2
  git worktree remove "$INT_WORKTREE" --force 2>/dev/null || rm -rf "$INT_WORKTREE"
fi

echo "  Creating integration worktree: $INT_WORKTREE ($INT_BRANCH)" >&2
git worktree add -b "$INT_BRANCH" "$INT_WORKTREE" HEAD >&2
echo "$INT_BRANCH" > "$INT_WORKTREE/.meow-branch"

echo "Setup complete: $TASK_COUNT task worktrees + integration" >&2

# Write enriched tasks to file for downstream steps
printf '%s' "$ENRICHED" > .meow/worktrees/.enriched-tasks.json

# Write track dirs list
TRACK_DIRS=$(printf '%s' "$ENRICHED" | jq -r '[.[].name] | map(. + "-track") | join(", ")')
echo "$TRACK_DIRS" > .meow/worktrees/.track-dirs

# Write integration worktree path
echo ".meow/worktrees/sprint-integration-track" > .meow/worktrees/.integration-path

echo "Setup complete"
"""

[[setup.steps]]
id = "validate"
executor = "shell"
description = "Validate metadata files were created"
needs = ["create-worktrees"]
command = """
set -e

# Verify files exist
test -f .meow/worktrees/.enriched-tasks.json || { echo "ERROR: .enriched-tasks.json not found" >&2; exit 1; }
test -f .meow/worktrees/.track-dirs || { echo "ERROR: .track-dirs not found" >&2; exit 1; }
test -f .meow/worktrees/.integration-path || { echo "ERROR: .integration-path not found" >&2; exit 1; }

echo "Metadata validated:"
echo "  - Enriched tasks: $(jq 'length' .meow/worktrees/.enriched-tasks.json) tasks"
echo "  - Track dirs: $(cat .meow/worktrees/.track-dirs)"
"""

[[setup.steps]]
id = "done"
executor = "shell"
command = "echo 'Sprint setup complete'"
needs = ["validate"]


# ============================================================================
# INTEGRATION (Public)
# ============================================================================
#
# Spawns an integration agent to merge all task branches.
# Reads track directories from .meow/worktrees/.track-dirs.
#
# Variables:
#   spawn_args (optional) - Extra CLI args for spawned agent
#
# Usage:
#   [[main.steps]]
#   id = "integration"
#   executor = "expand"
#   template = "lib/sprint-common#integration"
#   variables = { spawn_args = "{{spawn_args}}" }

[integration]
name = "sprint-integration"
description = "Integration agent that merges all task branches"

[integration.variables]
spawn_args = { default = "", description = "Extra CLI args for claude" }

[[integration.steps]]
id = "spawn"
executor = "spawn"
agent = "agent-integration"
workdir = ".meow/worktrees/sprint-integration-track"
spawn_args = "{{spawn_args}}"

[[integration.steps]]
id = "work"
executor = "agent"
agent = "agent-integration"
needs = ["spawn"]
prompt = """
# Integration Agent: Merge All Sprint Tracks

Your job is to merge all feature branches into this integration worktree.
When parallel agents work on the same files, conflicts are expected. Resolve them.

## Find Branch Names

Read the track directories list and get branch names:
```bash
# List of tracks to merge
TRACK_DIRS=$(cat ../.track-dirs 2>/dev/null || cat .meow/worktrees/.track-dirs)
echo "Tracks to merge: $TRACK_DIRS"

# For each track, the branch is in ../<track-dir>/.meow-branch
```

## Merge Each Branch

For each track directory:
```bash
BRANCH=$(cat ../<track-dir>/.meow-branch)
git merge "$BRANCH" --no-edit -m "Merge: <track-name>"
```

If the merge succeeds, continue to the next branch.

## If Conflicts Occur

When you see "CONFLICT" in the output:
1. Run `git status` to see conflicted files
2. For `.meow-branch` conflicts: just pick either version
   ```bash
   git checkout --theirs .meow-branch
   git add .meow-branch
   ```
3. For test file conflicts (e.g., `*_test.go`):
   - Both branches typically added content at the end
   - Keep BOTH sets of content (combine them)
   - Remove conflict markers (`<<<<<<<`, `=======`, `>>>>>>>`)
4. For other conflicts:
   - Read both versions carefully
   - Combine logically (don't lose either side's changes)
5. Stage resolved files: `git add <file>`
6. Complete the merge: `git commit -m "Merge: <track-name> (conflicts resolved)"`
7. Continue with the next branch

## After All Merges

1. Run `go build ./...` to verify build passes
2. Run `go test -short ./...` to verify tests pass
3. If tests fail, fix the issues and commit

When all tracks are merged and tests pass: `meow done`
"""

[[integration.steps]]
id = "review"
executor = "agent"
agent = "agent-integration"
needs = ["work"]
prompt = """
# Integration Review

All tracks should be merged. Final verification:

1. `git log --oneline -20` - verify all merges present
2. `go build ./...` - verify build
3. `go test -short ./...` - verify tests

Fix any issues you find.

When verified: `meow done`
"""

[[integration.steps]]
id = "kill"
executor = "kill"
agent = "agent-integration"
needs = ["review"]
graceful = true

[[integration.steps]]
id = "done"
executor = "shell"
command = "echo 'Integration complete - all tracks merged successfully'"
needs = ["kill"]


# ============================================================================
# AGENT TRACK WRAPPER (Public)
# ============================================================================
#
# Wraps lib/agent-track with spec_file handling.
# This is the adapter used by foreach iterations.
#
# Variables:
#   task (required) - Task object with {name, prompt, workdir, beads}
#   i (required) - Task index (for agent naming)
#   + all the standard agent track options
#
# Usage:
#   [[main.steps]]
#   id = "agent"
#   executor = "expand"
#   template = "lib/sprint-common#agent-track-wrapper"
#   variables = { task = "{{task}}", i = "{{i}}", ... }

[agent-track-wrapper]
name = "agent-track-wrapper"
description = "Wrapper for agent track with spec handling"

[agent-track-wrapper.variables]
task = { required = true, description = "Task object with name, prompt, workdir, beads" }
i = { required = true, description = "Task index for agent naming" }
spec_file = { default = "docs/MVP-SPEC-v2.md", description = "Spec file to read first (use 'none' to skip)" }
spawn_args = { default = "", description = "Extra CLI args for claude" }
enable_rw = { default = "true", description = "Enable Ralph Wiggum persistence monitor" }
max_nudges = { default = "10", description = "Max nudges before force-completing" }
enable_context_monitor = { default = "true", description = "Enable context usage auto-compact" }
context_threshold = { default = "70", description = "Context % to trigger /compact" }

[[agent-track-wrapper.steps]]
id = "track"
executor = "expand"
template = "lib/agent-track"

[agent-track-wrapper.steps.variables]
agent_name = "agent-{{i}}"
track_name = "{{task.name}}"
workdir = "{{task.workdir}}"
task_prompt = """
{{task.prompt}}

## Bead References (if any)
{{task.beads}}

If bead IDs are listed above, close them as you complete: `bd close <bead-id>`
"""
# Only include spec_file if it's not "none"
spec_file = "{{spec_file}}"
spawn_args = "{{spawn_args}}"
enable_rw = "{{enable_rw}}"
max_nudges = "{{max_nudges}}"
enable_context_monitor = "{{enable_context_monitor}}"
context_threshold = "{{context_threshold}}"

# Done marker that downstream can reference
[[agent-track-wrapper.steps]]
id = "done"
executor = "shell"
command = "echo 'Track {{task.name}} complete'"
needs = ["track.done"]


# ============================================================================
# CLEANUP (Public)
# ============================================================================
#
# Cleans up sprint worktrees. Call this on success or manual cleanup.
#
# Usage:
#   [[main.steps]]
#   id = "cleanup"
#   executor = "expand"
#   template = "lib/sprint-common#cleanup"

[cleanup]
name = "sprint-cleanup"
description = "Clean up sprint worktrees"

[[cleanup.steps]]
id = "remove"
executor = "shell"
command = """
echo "Cleaning up sprint worktrees..."

# Parse task names from enriched file and remove each worktree
for name in $(jq -r '.[].name' .meow/worktrees/.enriched-tasks.json 2>/dev/null || echo ""); do
  git worktree remove ".meow/worktrees/${name}-track" --force 2>/dev/null || rm -rf ".meow/worktrees/${name}-track"
done

# Remove integration worktree
git worktree remove .meow/worktrees/sprint-integration-track --force 2>/dev/null || rm -rf .meow/worktrees/sprint-integration-track

# Clean up temp files
rm -f .meow/worktrees/.enriched-tasks.json .meow/worktrees/.tasks.json .meow/worktrees/.track-dirs .meow/worktrees/.integration-path

echo "Cleanup complete"
"""


# ============================================================================
# FINAL SUMMARY (Public)
# ============================================================================
#
# Prints summary of completed sprint.
#
# Variables:
#   target_branch - Target branch for final merge
#   skip_merge_to_target - Whether merge was skipped
#
# Usage:
#   [[main.steps]]
#   id = "summary"
#   executor = "expand"
#   template = "lib/sprint-common#summary"

[summary]
name = "sprint-summary"
description = "Print sprint completion summary"

[summary.variables]
target_branch = { default = "main", description = "Target branch" }
skip_merge_to_target = { default = "false", description = "Whether merge was skipped" }

[[summary.steps]]
id = "print"
executor = "shell"
command = """
echo "=============================================="
echo "  SPRINT COMPLETE"
echo "=============================================="
echo ""
echo "Tasks completed:"
jq -r '.[] | "  - \\(.name): \\(.branch)"' .meow/worktrees/.enriched-tasks.json
echo ""
echo "Target branch: {{target_branch}}"
echo "Skip merge mode: {{skip_merge_to_target}}"
echo "=============================================="
"""
