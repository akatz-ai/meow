# ============================================================================
# MEOW Library: Git Worktree Creation
# ============================================================================
#
# Creates an isolated git worktree for an agent to work in.
#
# Variables:
#   track_name (required) - Name for the track/worktree
#
# Outputs:
#   path   - Path to the created worktree
#   branch - Name of the created branch
#
# Usage:
#   [[main.steps]]
#   id = "setup-worktree"
#   executor = "expand"
#   template = "lib/worktree"
#   variables = { track_name = "feature-x" }
#
# ============================================================================

[main]
name = "worktree"
description = "Create a git worktree for isolated agent work"

[main.variables]
track_name = { required = true, description = "Name for this track/worktree" }

[[main.steps]]
id = "create"
executor = "shell"
description = "Create worktree for {{track_name}}"
command = """
set -e
WORKTREE=".meow/worktrees/{{track_name}}-track"
BRANCH="{{track_name}}-track-$(date +%s)"

# Clean up existing worktree if present (from failed previous run)
if [ -d "$WORKTREE" ]; then
    echo "Cleaning up existing worktree..." >&2
    git worktree remove "$WORKTREE" --force 2>/dev/null || rm -rf "$WORKTREE"
fi

git worktree add -b "$BRANCH" "$WORKTREE" HEAD >&2
echo "$BRANCH" > "$WORKTREE/.meow-branch"
echo "$WORKTREE"
"""

[main.steps.shell_outputs]
path = { source = "stdout" }
branch = { source = "file:.meow/worktrees/{{track_name}}-track/.meow-branch" }
