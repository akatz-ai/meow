# ═══════════════════════════════════════════════════════════════════════════════
# PARALLEL VALIDATION TEMPLATE
# ═══════════════════════════════════════════════════════════════════════════════
# Demonstrates parallel fork-join execution with multiple validation steps
# running simultaneously in separate Claude sessions/worktrees.
#
# Flow:
#   1. Prepare validation context
#   2. FORK into parallel branches:
#      - review: Code review in worktree meow/review-XXX
#      - test: Test suite in worktree meow/test-XXX
#      - lint: Static analysis in worktree meow/lint-XXX
#   3. JOIN when all branches complete
#   4. Merge results and continue
# ═══════════════════════════════════════════════════════════════════════════════

[meta]
name = "parallel-validation"
version = "1.0.0"
description = "Parallel code validation with review, testing, and linting"
author = "meow-stack"

# Parallel execution settings
parallel_failure_mode = "continue"  # continue | fail_fast | isolate

# Error handling
on_error = "inject-gate"

# ───────────────────────────────────────────────────────────────────────────────
# Variables
# ───────────────────────────────────────────────────────────────────────────────

[variables]
task_id = { required = true, description = "The task bead being validated" }
run_lint = { required = false, default = true, type = "bool" }

# ───────────────────────────────────────────────────────────────────────────────
# Steps
# ───────────────────────────────────────────────────────────────────────────────

[[steps]]
id = "prepare"
description = "Prepare context for parallel validation"
instructions = """
Gather information for parallel validators:

1. List changed files: `git diff --name-only HEAD~1`
2. Identify test files related to changes
3. Note any special review concerns

Record in notes for parallel branches to reference.
"""

# ─────────────────────────────────────────────────────────────────────────────
# PARALLEL FORK - These three steps run simultaneously
# ─────────────────────────────────────────────────────────────────────────────

[[steps]]
id = "review"
description = "Code review"
needs = ["prepare"]
parallel = true                      # ← Marks as parallel-capable
parallel_group = "validation"        # ← Groups parallel siblings
spawn_mode = "clone"                 # ← Inherit parent context via --resume
template = "review"                  # ← Expands to review molecule
variables = { task_id = "{{task_id}}" }

[[steps]]
id = "test"
description = "Run test suite"
needs = ["prepare"]
parallel = true
parallel_group = "validation"
spawn_mode = "clone"                 # Clone: sees parent context
template = "test-suite"

[[steps]]
id = "lint"
description = "Static analysis"
needs = ["prepare"]
parallel = true
parallel_group = "validation"
spawn_mode = "fresh"                 # Fresh: starts with clean context
template = "lint"                    # Linting doesn't need parent context
condition = "{{run_lint}}"           # Only if run_lint is true

# ─────────────────────────────────────────────────────────────────────────────
# JOIN POINT - Waits for all parallel branches to complete
# ─────────────────────────────────────────────────────────────────────────────

[[steps]]
id = "merge-results"
description = "Merge validation results"
needs = ["review", "test", "lint"]   # ← Join point: waits for all
join_condition = "all"               # Wait for all branches
instructions = """
## Merge Parallel Results

The orchestrator has merged git branches from parallel workers.
Review the aggregated handoff context:

### Review Branch ({{handoff.review.status}})
{{handoff.review.summary}}

### Test Branch ({{handoff.test.status}})
{{handoff.test.summary}}

### Lint Branch ({{handoff.lint.status}})
{{handoff.lint.summary}}

## Validation Decision

Based on all results:
- [ ] All checks passed → proceed
- [ ] Issues found → document and decide
- [ ] Conflicts in merge → resolve first
"""

[[steps]]
id = "finalize"
description = "Finalize validation"
needs = ["merge-results"]
condition = """
  # Only finalize if all validations passed
  jq -e '.review.status == "success" and .test.status == "success"' \
    .beads/molecules/{{molecule_id}}/aggregated-handoff.json
"""
instructions = """
All validations passed. Finalize:

1. Update task status: `bd update {{task_id}} --labels "validated"`
2. Write summary for human gate (if next)
3. Commit any remaining changes
"""
