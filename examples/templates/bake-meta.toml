# ═══════════════════════════════════════════════════════════════════════════════
# BAKE-META TEMPLATE
# ═══════════════════════════════════════════════════════════════════════════════
# Dynamically creates a meta-molecule from selected tasks.
#
# Flow:
#   1. Load selection - get tasks from analyze-pick step
#   2. Design molecule - plan the meta-molecule structure
#   3. Create molecule - bake the actual molecule bead
# ═══════════════════════════════════════════════════════════════════════════════

[meta]
name = "bake-meta"
version = "1.0.0"
description = "Create meta-molecule from selected tasks"
author = "meow-stack"

fits_in_context = true
estimated_minutes = 5

# ───────────────────────────────────────────────────────────────────────────────
# Variables
# ───────────────────────────────────────────────────────────────────────────────

[variables]
selected_tasks = { required = true, description = "Task IDs selected by analyze-pick" }
selected_epic = { required = false, description = "Epic to close if all its tasks are included" }
gate_frequency = { required = false, default = 1, type = "int", description = "Insert gate every N epics" }
include_test_suite = { required = false, default = true, type = "bool", description = "Run full test suite before gate" }
task_template = { required = false, default = "implement", description = "Template for task steps" }

# ───────────────────────────────────────────────────────────────────────────────
# Steps
# ───────────────────────────────────────────────────────────────────────────────

[[steps]]
id = "load-selection"
description = "Load the task selection from analyze-pick"
instructions = """
## Load Selected Tasks

Parse the selection from the analyze-pick step.

### Input Format:
```yaml
selected_tasks:
  - id: bd-task-001
    title: "Create registration endpoint"
  - id: bd-task-002
    title: "Add email validation"
selected_epic: bd-epic-001
epic_will_complete: true
```

### Validate:
- All task IDs exist in beads
- Tasks are in correct status (open)
- No circular dependencies
- Epic exists if specified

### Command:
```bash
# Verify each task
bd show {{task_id}}
```
"""

[[steps]]
id = "design-molecule"
description = "Design the meta-molecule structure"
needs = ["load-selection"]
instructions = """
## Design Meta-Molecule

Plan the structure of the meta-molecule.

### Structure Pattern:

```
[task-1] → [task-2] → ... → [close-epic] → [test-suite] → [human-gate]
    ↓          ↓
 (expand)   (expand)
    ↓          ↓
implement  implement
 molecule   molecule
```

### Step Planning:

1. **Task Steps** (one per selected task)
   - Template: {{task_template}}
   - Variables: task_id, epic_id (if applicable)
   - Order: respect dependencies between tasks

2. **Close Epic Step** (if epic will complete)
   - Template: close-epic
   - Only if all epic's tasks are in this batch
   - Variables: epic_id

3. **Test Suite Step** (if enabled)
   {{#if include_test_suite}}
   - Template: test-suite
   - Runs after all tasks and epic close
   {{/if}}

4. **Human Gate Step**
   - Template: human-gate
   - Always last
   - Includes summary of all completed work

### Dependency Graph:

```
task-1 ─┬─► task-2 ─┬─► close-epic ─► test-suite ─► human-gate
        │           │        ↑
        │           │        │ (only if epic completes)
        └───────────┴────────┘
```

### Output:
Define the molecule structure in step notes.
"""

[[steps]]
id = "create-molecule"
description = "Create the meta-molecule in beads"
needs = ["design-molecule"]
output = "bake_result"
instructions = """
## Create Meta-Molecule

Bake the designed molecule into actual beads.

### Create Parent Bead:
```bash
bd create --type molecule \
  --title "Meta: {{selected_epic}} batch" \
  --description "Meta-molecule for: {{selected_tasks}}"
```

Record the created molecule ID (e.g., `meta-mol-001`).

### Create Step Beads:

For each task in order:
```bash
bd create --type task \
  --parent {{molecule_id}} \
  --title "Implement: {{task.title}}" \
  --labels "template:{{task_template}}" \
  --meta "task_id={{task.id}},template={{task_template}}"
```

Add dependencies:
```bash
bd dep add {{step_n}} {{step_n-1}}  # Each step depends on previous
```

### Create Close-Epic Step (if applicable):
```bash
bd create --type task \
  --parent {{molecule_id}} \
  --title "Close: {{epic.title}}" \
  --labels "template:close-epic" \
  --meta "epic_id={{selected_epic}}"
```

### Create Test-Suite Step:
{{#if include_test_suite}}
```bash
bd create --type task \
  --parent {{molecule_id}} \
  --title "Test Suite" \
  --labels "template:test-suite"
```
{{/if}}

### Create Human-Gate Step:
```bash
bd create --type gate \
  --parent {{molecule_id}} \
  --title "Human Review Gate" \
  --labels "template:human-gate"
```

### Verify:
```bash
bd show {{molecule_id}}  # Should show all child steps
bd dep tree {{molecule_id}}  # Should show correct dependencies
```

### Output:
```yaml
molecule_id: meta-mol-001
steps:
  - id: meta-mol-001.task-1
    template: implement
    target: bd-task-001
  - id: meta-mol-001.task-2
    template: implement
    target: bd-task-002
  - id: meta-mol-001.close-epic
    template: close-epic
    target: bd-epic-001
  - id: meta-mol-001.test-suite
    template: test-suite
  - id: meta-mol-001.human-gate
    template: human-gate
total_steps: 5
```

Record this output for the outer-loop to reference.
"""
